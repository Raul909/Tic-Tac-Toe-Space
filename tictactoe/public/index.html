<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>TIC ¬∑ TAC ¬∑ TOE ‚Äî Multiplayer</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Space+Mono:wght@400;700&display=swap"
    rel="stylesheet">
  <script src="/socket.io/socket.io.js"></script>
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --x: #ff4d6d;
      --o: #4dffdb;
      --bg: #05060e;
      --s1: rgba(255, 255, 255, 0.04);
      --s2: rgba(255, 255, 255, 0.08);
      --s3: rgba(255, 255, 255, 0.14);
      --gx: 0 0 20px #ff4d6d88, 0 0 60px #ff4d6d33;
      --go: 0 0 20px #4dffdb88, 0 0 60px #4dffdb33;
      --r: 14px;
    }

    html,
    body {
      height: 100%;
      background: var(--bg);
      color: #fff;
      font-family: 'Space Mono', monospace;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    @supports(-webkit-touch-callout:none) {
      body {
        min-height: -webkit-fill-available;
      }
    }

    /* BG */
    #canvas-bg {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
    }

    .aurora {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      background: radial-gradient(ellipse 80% 40% at 20% 10%, rgba(255, 77, 109, 0.07) 0%, transparent 60%),
        radial-gradient(ellipse 60% 50% at 80% 90%, rgba(77, 255, 219, 0.07) 0%, transparent 60%),
        radial-gradient(ellipse 100% 60% at 50% 50%, rgba(80, 40, 120, 0.06) 0%, transparent 70%);
      animation: auroraShift 14s ease-in-out infinite alternate;
    }

    @keyframes auroraShift {
      0% {
        opacity: 0.7;
        transform: scale(1)
      }

      50% {
        opacity: 1;
        transform: scale(1.05)
      }

      100% {
        opacity: 0.6;
        transform: scale(0.97)
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0
      }

      to {
        opacity: 0.6
      }
    }

    .grid-deco {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      opacity: 0.02;
      background-image: linear-gradient(rgba(255, 255, 255, 1) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 1) 1px, transparent 1px);
      background-size: 56px 56px;
    }

    #fw-canvas {
      position: fixed;
      inset: 0;
      z-index: 10;
      pointer-events: none;
    }

    #screen-flash {
      position: fixed;
      inset: 0;
      z-index: 25;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.06s;
    }

    #screen-flash.flash {
      opacity: 1;
    }

    #toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(16px);
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.14);
      backdrop-filter: blur(14px);
      border-radius: 30px;
      padding: 10px 24px;
      font-size: 0.65rem;
      letter-spacing: 0.1em;
      z-index: 100;
      opacity: 0;
      transition: all 0.3s;
      pointer-events: none;
      white-space: nowrap;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
    }

    #toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    #weather-badge {
      position: fixed;
      top: clamp(12px, 3vw, 20px);
      right: clamp(12px, 3vw, 20px);
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 6px 14px;
      font-size: clamp(0.45rem, 1.8vw, 0.5rem);
      letter-spacing: 0.15em;
      text-transform: uppercase;
      opacity: 0.6;
      z-index: 50;
      display: none;
    }

    #weather-badge.show {
      display: block;
      animation: fadeIn 1s ease;
    }

    @media(max-width:500px) {
      #weather-badge {
        top: auto;
        bottom: 70px;
        right: 12px;
        font-size: 0.45rem;
        padding: 4px 10px;
      }
    }

    /* SPACE GALLERY */
    #screen-space {
      padding: 0;
      overflow: hidden;
    }

    .space-gallery-container {
      display: grid;
      grid-template-rows: auto 1fr;
      grid-template-columns: 1fr 280px;
      height: 100vh;
      width: 100vw;
      gap: 0;
    }

    @media(max-width:900px) {
      .space-gallery-container {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr auto;
      }

      .space-sidebar {
        max-height: 180px;
        padding: 12px;
      }

      .space-header {
        padding: 12px 16px;
        gap: 12px;
      }

      .space-tabs {
        width: 100%;
      }

      .space-tab {
        flex: 1;
        min-width: 0;
        padding: 6px 8px;
        font-size: 0.5rem;
      }

      .space-controls {
        flex-direction: column;
        gap: 8px;
        padding: 8px 12px;
        bottom: 5px;
      }

      .space-control-group {
        width: 100%;
      }

      input[type="range"] {
        width: 100%;
      }
    }

    .space-header {
      grid-column: 1/-1;
      background: rgba(255, 255, 255, 0.03);
      border-bottom: 1px solid var(--s2);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .space-title {
      font-family: 'Orbitron', sans-serif;
      font-size: clamp(1rem, 3vw, 1.3rem);
      font-weight: 700;
      letter-spacing: 0.2em;
      margin: 0;
      flex: 1;
      min-width: 200px;
    }

    .space-tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .space-tab {
      font-family: 'Space Mono', monospace;
      font-size: clamp(0.55rem, 2vw, 0.6rem);
      letter-spacing: 0.1em;
      text-transform: uppercase;
      padding: 8px 16px;
      border-radius: 20px;
      border: 1px solid var(--s2);
      background: transparent;
      color: #666;
      cursor: pointer;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }

    .space-tab.active {
      color: #fff;
      background: var(--s1);
      border-color: rgba(77, 255, 219, 0.3);
    }

    .space-tab:hover:not(.active) {
      color: #aaa;
      background: rgba(255, 255, 255, 0.02);
    }

    .space-canvas-wrap {
      position: relative;
      overflow: hidden;
      background: radial-gradient(ellipse at center, rgba(20, 25, 40, 1), rgba(5, 6, 14, 1));
    }

    #space-canvas {
      width: 100%;
      height: 100%;
      display: block;
      cursor: grab;
    }

    #space-canvas:active {
      cursor: grabbing;
    }

    .space-info {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      padding: 12px 18px;
      font-size: 0.7rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      max-width: 250px;
    }

    .space-info.show {
      opacity: 1;
    }

    .space-info-name {
      font-family: 'Orbitron', sans-serif;
      font-size: 0.9rem;
      font-weight: 700;
      margin-bottom: 6px;
      color: var(--o);
    }

    .space-info-type {
      font-size: 0.6rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      opacity: 0.5;
      margin-bottom: 8px;
    }

    .space-info-data {
      font-size: 0.65rem;
      line-height: 1.6;
      opacity: 0.8;
    }

    .space-controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 30px;
      padding: 12px 20px;
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
    }

    @media(max-width:600px) {
      .space-controls {
        bottom: 10px;
        padding: 8px 12px;
        gap: 10px;
        font-size: 0.7rem;
      }
    }

    .space-control-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .space-control-label {
      font-size: 0.6rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      opacity: 0.6;
    }

    input[type="range"] {
      width: 80px;
      height: 4px;
      background: var(--s2);
      border-radius: 2px;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 14px;
      height: 14px;
      background: var(--o);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 0 8px var(--o);
    }

    input[type="range"]::-moz-range-thumb {
      width: 14px;
      height: 14px;
      background: var(--o);
      border-radius: 50%;
      cursor: pointer;
      border: none;
      box-shadow: 0 0 8px var(--o);
    }

    .btn-small {
      font-family: 'Space Mono', monospace;
      font-size: 0.55rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      padding: 6px 12px;
      border-radius: 20px;
      border: 1px solid var(--s2);
      background: var(--s1);
      color: #fff;
      cursor: pointer;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }

    .btn-small:hover {
      background: var(--s3);
    }

    .space-sidebar {
      background: rgba(255, 255, 255, 0.02);
      border-left: 1px solid var(--s2);
      padding: 20px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--s2) transparent;
    }

    @media(max-width:900px) {
      .space-sidebar {
        border-left: none;
        border-top: 1px solid var(--s2);
        max-height: 200px;
      }
    }

    .space-sidebar::-webkit-scrollbar {
      width: 4px;
    }

    .space-sidebar::-webkit-scrollbar-thumb {
      background: var(--s2);
      border-radius: 2px;
    }

    .space-sidebar-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 0.2em;
      margin-bottom: 16px;
      opacity: 0.6;
      text-transform: uppercase;
    }

    .space-objects-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .space-object-item {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 10px;
      padding: 10px 12px;
      cursor: pointer;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }

    .space-object-item:hover {
      background: rgba(255, 255, 255, 0.06);
      border-color: rgba(77, 255, 219, 0.3);
      transform: translateX(4px);
    }

    .space-object-item.active {
      border-color: var(--o);
      background: rgba(77, 255, 219, 0.05);
    }

    .space-object-name {
      font-size: 0.7rem;
      font-weight: 700;
      margin-bottom: 2px;
    }

    .space-object-type {
      font-size: 0.55rem;
      opacity: 0.5;
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }

    /* SCREENS */
    .screen {
      position: fixed;
      inset: 0;
      z-index: 2;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s cubic-bezier(.4, 0, .2, 1);
    }

    .screen.active {
      opacity: 1;
      pointer-events: all;
    }

    /* AUTH */
    #screen-auth {
      flex-direction: column;
      gap: 32px;
      padding: 20px;
    }

    .brand {
      font-family: 'Orbitron', sans-serif;
      font-weight: 900;
      font-size: clamp(1.4rem, 6vw, 2.8rem);
      letter-spacing: 0.3em;
      background: linear-gradient(90deg, var(--x), #fff 50%, var(--o));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      text-align: center;
      animation: brandGlow 5s ease-in-out infinite alternate;
    }

    @keyframes brandGlow {
      0% {
        filter: drop-shadow(0 0 16px #ff4d6d66)
      }

      100% {
        filter: drop-shadow(0 0 16px #4dffdb66)
      }
    }

    .brand-sub {
      font-size: clamp(0.5rem, 2vw, 0.6rem);
      letter-spacing: 0.35em;
      opacity: 0.3;
      text-align: center;
      margin-top: -18px;
      text-transform: uppercase;
    }

    .auth-box {
      background: rgba(255, 255, 255, 0.035);
      border: 1px solid rgba(255, 255, 255, 0.09);
      border-radius: 22px;
      backdrop-filter: blur(24px);
      width: min(380px, 92vw);
      overflow: hidden;
      box-shadow: 0 30px 80px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.08);
      animation: boxIn 0.55s cubic-bezier(.34, 1.56, .64, 1) both;
    }

    @keyframes boxIn {
      from {
        transform: translateY(32px) scale(0.88);
        opacity: 0
      }
    }

    .tab-bar {
      display: grid;
      grid-template-columns: 1fr 1fr;
      border-bottom: 1px solid var(--s2);
    }

    .tab-btn {
      font-family: 'Space Mono', monospace;
      font-size: clamp(0.55rem, 2vw, 0.65rem);
      letter-spacing: 0.2em;
      padding: 14px;
      border: none;
      background: transparent;
      color: #555;
      cursor: pointer;
      text-transform: uppercase;
      transition: all 0.25s;
      -webkit-tap-highlight-color: transparent;
    }

    .tab-btn.active {
      color: #fff;
      background: rgba(255, 255, 255, 0.05);
    }

    .tab-btn:hover:not(.active) {
      color: #aaa;
    }

    .auth-form {
      padding: clamp(20px, 5vw, 28px);
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .field-label {
      font-size: clamp(0.5rem, 1.8vw, 0.55rem);
      letter-spacing: 0.2em;
      text-transform: uppercase;
      opacity: 0.35;
      padding-left: 2px;
    }

    .field-input {
      font-family: 'Space Mono', monospace;
      font-size: clamp(0.7rem, 2.5vw, 0.8rem);
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.09);
      border-radius: var(--r);
      padding: 12px 16px;
      color: #fff;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
      -webkit-appearance: none;
    }

    .field-input:focus {
      border-color: rgba(255, 255, 255, 0.28);
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.05);
    }

    .field-input::placeholder {
      opacity: 0.22;
    }

    .btn {
      font-family: 'Space Mono', monospace;
      font-size: clamp(0.6rem, 2vw, 0.65rem);
      letter-spacing: 0.15em;
      text-transform: uppercase;
      padding: 12px 24px;
      border-radius: 30px;
      border: 1px solid var(--s2);
      background: var(--s1);
      color: #fff;
      cursor: pointer;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }

    .btn:hover {
      background: var(--s3);
      transform: translateY(-2px);
    }

    .btn:active {
      transform: scale(0.96);
    }

    .btn-primary {
      background: linear-gradient(135deg, rgba(255, 77, 109, 0.18), rgba(77, 255, 219, 0.18));
      border-color: rgba(255, 255, 255, 0.18);
      padding: 14px;
      font-size: clamp(0.65rem, 2.2vw, 0.7rem);
      letter-spacing: 0.2em;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, rgba(255, 77, 109, 0.32), rgba(77, 255, 219, 0.32));
      box-shadow: 0 0 30px rgba(255, 77, 109, 0.2), 0 0 60px rgba(77, 255, 219, 0.1);
    }

    .auth-error {
      font-size: clamp(0.6rem, 2vw, 0.65rem);
      color: var(--x);
      text-align: center;
      letter-spacing: 0.05em;
      min-height: 18px;
    }

    @keyframes errShake {

      0%,
      100% {
        transform: translateX(0)
      }

      20% {
        transform: translateX(-5px)
      }

      60% {
        transform: translateX(5px)
      }
    }

    .shake {
      animation: errShake 0.35s ease;
    }

    /* LOBBY */
    #screen-lobby {
      flex-direction: column;
      gap: 22px;
      padding: clamp(16px, 4vw, 20px);
    }

    .lobby-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: min(520px, 95vw);
      flex-wrap: wrap;
      gap: 12px;
    }

    @media(max-width:600px) {
      .lobby-top {
        flex-direction: column;
        align-items: stretch;
      }

      .lobby-top>div:last-child {
        justify-content: center;
        flex-wrap: wrap;
      }

      .brand {
        font-size: clamp(1rem, 5vw, 1.2rem) !important;
      }
    }

    .user-chip {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--s1);
      border: 1px solid var(--s2);
      border-radius: 30px;
      padding: 8px 16px;
    }

    .user-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--x), var(--o));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
      color: var(--bg);
    }

    .user-name {
      font-size: clamp(0.65rem, 2.5vw, 0.7rem);
    }

    .stat-pill {
      font-size: clamp(0.5rem, 2vw, 0.55rem);
      letter-spacing: 0.1em;
      padding: 4px 10px;
      border-radius: 20px;
      border: 1px solid var(--s2);
      background: var(--s1);
    }

    .stat-pill.w {
      color: var(--o);
      border-color: rgba(77, 255, 219, 0.3);
    }

    .stat-pill.l {
      color: var(--x);
      border-color: rgba(255, 77, 109, 0.3);
    }

    .stat-pill.d {
      color: #888;
    }

    .lobby-card {
      background: var(--s1);
      border: 1px solid var(--s2);
      border-radius: 20px;
      backdrop-filter: blur(18px);
      width: min(520px, 95vw);
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
      animation: boxIn 0.4s cubic-bezier(.34, 1.56, .64, 1) both;
    }

    .lobby-section {
      padding: clamp(18px, 4vw, 24px);
      border-bottom: 1px solid var(--s2);
    }

    .lobby-section:last-child {
      border-bottom: none;
    }

    .lobby-section-title {
      font-size: clamp(0.5rem, 2vw, 0.55rem);
      letter-spacing: 0.25em;
      text-transform: uppercase;
      opacity: 0.3;
      margin-bottom: 14px;
    }

    .big-btn {
      font-family: 'Orbitron', sans-serif;
      font-size: clamp(0.7rem, 2.5vw, 0.75rem);
      font-weight: 700;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      width: 100%;
      padding: 16px;
      border-radius: 12px;
      border: 1px solid;
      background: transparent;
      cursor: pointer;
      transition: all 0.25s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      -webkit-tap-highlight-color: transparent;
    }

    .big-btn-create {
      color: var(--x);
      border-color: rgba(255, 77, 109, 0.35);
    }

    .big-btn-create:hover {
      background: rgba(255, 77, 109, 0.1);
      box-shadow: var(--gx);
      transform: translateY(-2px);
    }

    .big-btn-ai {
      color: var(--o);
      border-color: rgba(77, 255, 219, 0.35);
    }

    .big-btn-ai:hover {
      background: rgba(77, 255, 219, 0.1);
      box-shadow: var(--go);
      transform: translateY(-2px);
    }

    .lobby-modes {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    @media(max-width:500px) {
      .lobby-modes {
        grid-template-columns: 1fr;
      }
    }

    .join-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .join-input {
      font-family: 'Orbitron', monospace;
      font-size: clamp(0.9rem, 3vw, 1rem);
      font-weight: 700;
      letter-spacing: 0.25em;
      text-transform: uppercase;
      flex: 1;
      min-width: 120px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--s2);
      border-radius: 10px;
      padding: 12px 16px;
      color: #fff;
      outline: none;
      text-align: center;
      transition: border-color 0.2s;
      -webkit-appearance: none;
    }

    .join-input:focus {
      border-color: rgba(255, 255, 255, 0.28);
    }

    .join-input::placeholder {
      opacity: 0.22;
      font-size: 0.7rem;
      letter-spacing: 0.2em;
    }

    .btn-join {
      font-family: 'Space Mono', monospace;
      padding: 12px 20px;
      background: var(--s1);
      border: 1px solid var(--s2);
      border-radius: 10px;
      color: #fff;
      cursor: pointer;
      font-size: clamp(0.6rem, 2vw, 0.65rem);
      letter-spacing: 0.1em;
      text-transform: uppercase;
      transition: all 0.2s;
      white-space: nowrap;
      -webkit-tap-highlight-color: transparent;
    }

    .btn-join:hover {
      background: var(--s3);
      transform: translateY(-1px);
    }

    .lobby-error {
      font-size: clamp(0.55rem, 2vw, 0.6rem);
      color: var(--x);
      letter-spacing: 0.05em;
      margin-top: 8px;
      min-height: 16px;
    }

    .logout-btn {
      font-family: 'Space Mono', monospace;
      font-size: clamp(0.5rem, 2vw, 0.55rem);
      letter-spacing: 0.1em;
      text-transform: uppercase;
      padding: 6px 14px;
      border-radius: 20px;
      border: 1px solid var(--s2);
      background: transparent;
      color: #555;
      cursor: pointer;
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }

    .logout-btn:hover {
      color: var(--x);
      border-color: rgba(255, 77, 109, 0.3);
    }

    .icon-btn {
      background: var(--s1);
      border: 1px solid var(--s2);
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 1.2rem;
      -webkit-tap-highlight-color: transparent;
    }

    .icon-btn:hover {
      background: var(--s3);
      transform: scale(1.1);
    }

    /* WAITING */
    #screen-waiting {
      flex-direction: column;
      gap: 24px;
      text-align: center;
    }

    .waiting-card {
      background: var(--s1);
      border: 1px solid var(--s2);
      border-radius: 22px;
      backdrop-filter: blur(20px);
      padding: 44px 52px;
      width: min(380px, 90vw);
      box-shadow: 0 30px 80px rgba(0, 0, 0, 0.5);
      animation: boxIn 0.45s cubic-bezier(.34, 1.56, .64, 1) both;
    }

    .waiting-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 0.9rem;
      font-weight: 700;
      letter-spacing: 0.2em;
      margin-bottom: 28px;
      opacity: 0.6;
    }

    .room-code-display {
      font-family: 'Orbitron', sans-serif;
      font-size: 3rem;
      font-weight: 900;
      letter-spacing: 0.35em;
      color: var(--x);
      margin-bottom: 8px;
      animation: codePulse 2.5s ease-in-out infinite;
    }

    @keyframes codePulse {

      0%,
      100% {
        text-shadow: 0 0 20px #ff4d6d88, 0 0 50px #ff4d6d44
      }

      50% {
        text-shadow: 0 0 40px #ff4d6dcc, 0 0 90px #ff4d6d66
      }
    }

    .room-code-label {
      font-size: 0.5rem;
      letter-spacing: 0.25em;
      opacity: 0.3;
      margin-bottom: 28px;
    }

    .copy-btn {
      font-family: 'Space Mono', monospace;
      font-size: 0.6rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      padding: 10px 22px;
      border-radius: 30px;
      border: 1px solid var(--s2);
      background: var(--s1);
      color: #fff;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 28px;
      display: inline-block;
    }

    .copy-btn:hover {
      background: var(--s3);
    }

    .copy-btn.copied {
      border-color: rgba(77, 255, 219, 0.5);
      color: var(--o);
      box-shadow: var(--go);
    }

    .waiting-dots span {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.25);
      margin: 0 4px;
      animation: dotBounce 1.3s ease-in-out infinite;
    }

    .waiting-dots span:nth-child(2) {
      animation-delay: 0.22s;
    }

    .waiting-dots span:nth-child(3) {
      animation-delay: 0.44s;
    }

    @keyframes dotBounce {

      0%,
      80%,
      100% {
        transform: scale(0.6);
        opacity: 0.25
      }

      40% {
        transform: scale(1.1);
        opacity: 1
      }
    }

    /* GAME */
    #screen-game {
      flex-direction: row;
      align-items: stretch;
      justify-content: center;
      overflow-y: auto;
      padding: clamp(8px, 2vw, 16px);
      -webkit-overflow-scrolling: touch;
    }

    .game-layout {
      display: grid;
      grid-template-columns: 190px auto 250px;
      gap: 14px;
      align-items: center;
      width: min(740px, 100%);
      margin: auto;
    }

    @media(max-width:768px) {
      .game-layout {
        grid-template-columns: 1fr;
        max-width: min(400px, 95vw);
        gap: 12px;
      }

      #chat-col {
        display: none !important;
      }

      .player-panel {
        padding: 10px 14px !important;
      }

      #board {
        gap: 4px !important;
        padding: 8px !important;
      }

      .cell {
        width: clamp(65px, 20vw, 90px) !important;
        height: clamp(65px, 20vw, 90px) !important;
      }
    }

    @media(min-width:769px) and (max-width:900px) {
      .game-layout {
        grid-template-columns: 150px auto 200px;
        gap: 10px;
      }
    }

    .player-panel {
      background: var(--s1);
      border: 1px solid rgba(255, 255, 255, 0.07);
      border-radius: 18px;
      padding: clamp(14px, 3vw, 20px);
      transition: border-color 0.4s, box-shadow 0.4s, transform 0.3s;
    }

    @media(max-width:768px) {
      .player-panel {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 12px 16px;
      }

      .pp-symbol {
        margin-bottom: 0;
        font-size: clamp(1.5rem, 8vw, 2rem) !important;
      }

      .pp-score {
        margin-top: 0;
        margin-left: auto;
        font-size: clamp(1.5rem, 8vw, 2rem) !important;
      }

      .pp-turn {
        margin-top: 0;
      }

      .pp-name {
        font-size: clamp(0.6rem, 3vw, 0.7rem) !important;
      }

      .pp-role {
        font-size: clamp(0.45rem, 2.5vw, 0.5rem) !important;
      }
    }

    .player-panel.active-x {
      border-color: rgba(255, 77, 109, 0.55);
      box-shadow: var(--gx), inset 0 0 30px rgba(255, 77, 109, 0.05);
      transform: translateY(-2px);
    }

    .player-panel.active-o {
      border-color: rgba(77, 255, 219, 0.55);
      box-shadow: var(--go), inset 0 0 30px rgba(77, 255, 219, 0.05);
      transform: translateY(-2px);
    }

    .pp-symbol {
      font-family: 'Orbitron', sans-serif;
      font-size: clamp(1.8rem, 5vw, 2.2rem);
      font-weight: 900;
      margin-bottom: 10px;
    }

    @media(max-width:768px) {
      .pp-symbol {
        margin-bottom: 0;
      }
    }

    .pp-symbol.x {
      color: var(--x);
      text-shadow: var(--gx);
    }

    .pp-symbol.o {
      color: var(--o);
      text-shadow: var(--go);
    }

    .pp-name {
      font-size: clamp(0.65rem, 2.2vw, 0.72rem);
      font-weight: 700;
      margin-bottom: 4px;
      word-break: break-word;
    }

    .pp-role {
      font-size: clamp(0.45rem, 1.8vw, 0.5rem);
      letter-spacing: 0.2em;
      opacity: 0.3;
      text-transform: uppercase;
    }

    .pp-score {
      font-family: 'Orbitron', sans-serif;
      font-size: clamp(1.8rem, 5vw, 2.2rem);
      font-weight: 900;
      margin-top: 18px;
      text-align: center;
      color: rgba(255, 255, 255, 0.1);
      transition: color 0.4s, text-shadow 0.4s;
    }

    @media(max-width:768px) {
      .pp-score {
        margin-top: 0;
        margin-left: auto;
      }
    }

    .pp-score.hx {
      color: var(--x);
      text-shadow: var(--gx);
    }

    .pp-score.ho {
      color: var(--o);
      text-shadow: var(--go);
    }

    .pp-turn {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: clamp(0.45rem, 1.8vw, 0.5rem);
      letter-spacing: 0.15em;
      text-transform: uppercase;
      margin-top: 10px;
      opacity: 0;
      transition: opacity 0.3s;
    }

    @media(max-width:768px) {
      .pp-turn {
        margin-top: 0;
      }
    }

    .player-panel.active-x .pp-turn,
    .player-panel.active-o .pp-turn {
      opacity: 0.7;
    }

    .pp-turn-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      animation: tdp 1s ease-in-out infinite alternate;
    }

    .active-x .pp-turn-dot {
      background: var(--x);
      box-shadow: 0 0 8px var(--x);
    }

    .active-o .pp-turn-dot {
      background: var(--o);
      box-shadow: 0 0 8px var(--o);
    }

    @keyframes tdp {
      0% {
        transform: scale(0.8);
        opacity: 0.5
      }

      100% {
        transform: scale(1.3);
        opacity: 1
      }
    }

    .game-col {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .game-title-mini {
      font-family: 'Orbitron', sans-serif;
      font-weight: 900;
      font-size: clamp(0.7rem, 2.5vw, 1.1rem);
      letter-spacing: 0.3em;
      background: linear-gradient(90deg, var(--x), #fff 50%, var(--o));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .game-scores {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: center;
    }

    .gs-card {
      background: var(--s1);
      border: 1px solid rgba(255, 255, 255, 0.07);
      border-radius: 10px;
      padding: 6px 16px;
      text-align: center;
      min-width: 52px;
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    @keyframes flashX {

      0%,
      100% {}

      50% {
        border-color: var(--x);
        box-shadow: var(--gx);
      }
    }

    @keyframes flashO {

      0%,
      100% {}

      50% {
        border-color: var(--o);
        box-shadow: var(--go);
      }
    }

    .flash-x {
      animation: flashX 0.5s ease;
    }

    .flash-o {
      animation: flashO 0.5s ease;
    }

    .gs-val {
      font-family: 'Orbitron', sans-serif;
      font-size: clamp(1rem, 3vw, 1.2rem);
      font-weight: 700;
    }

    .gs-label {
      font-size: clamp(0.4rem, 1.5vw, 0.45rem);
      letter-spacing: 0.15em;
      opacity: 0.35;
      text-transform: uppercase;
    }

    .gs-sep {
      font-size: 0.45rem;
      opacity: 0.2;
    }

    #game-status {
      font-size: clamp(0.6rem, 2.2vw, 0.68rem);
      letter-spacing: 0.2em;
      text-transform: uppercase;
      height: 22px;
      text-align: center;
      transition: color 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      display: inline-block;
      animation: stpulse 1s ease-in-out infinite alternate;
    }

    @keyframes stpulse {
      0% {
        opacity: 0.4;
        transform: scale(0.8)
      }

      100% {
        opacity: 1;
        transform: scale(1.2)
      }
    }

    /* BOARD */
    #board-wrap {
      position: relative;
      filter: drop-shadow(0 20px 60px rgba(0, 0, 0, 0.6));
      touch-action: manipulation;
    }

    #board {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: clamp(5px, 1.5vw, 7px);
      padding: clamp(10px, 2.5vw, 13px);
      background: rgba(255, 255, 255, 0.025);
      border: 1px solid rgba(255, 255, 255, 0.07);
      border-radius: 20px;
      backdrop-filter: blur(12px);
      position: relative;
      z-index: 1;
    }

    @keyframes boardShake {

      0%,
      100% {
        transform: translate3d(0, 0, 0) rotate(0)
      }

      15% {
        transform: translate3d(-4px, 2px, 0) rotate(-0.5deg)
      }

      30% {
        transform: translate3d(5px, -3px, 0) rotate(0.5deg)
      }

      45% {
        transform: translate3d(-3px, 4px, 0) rotate(-0.3deg)
      }

      60% {
        transform: translate3d(4px, -2px, 0) rotate(0.3deg)
      }

      75% {
        transform: translate3d(-2px, 3px, 0) rotate(-0.2deg)
      }
    }

    #board.shake {
      animation: boardShake 0.5s cubic-bezier(.36, .07, .19, .97);
    }

    /* Win line canvas overlaid on board */
    #win-canvas {
      position: absolute;
      inset: 0;
      z-index: 10;
      pointer-events: none;
      border-radius: 20px;
    }

    .cell {
      width: clamp(70px, 18vw, 112px);
      height: clamp(70px, 18vw, 112px);
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.07);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: background 0.15s, border-color 0.2s, transform 0.12s, box-shadow 0.2s;
      animation: cellAppear 0.4s cubic-bezier(.34, 1.56, .64, 1) both;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }

    .cell:nth-child(1) {
      animation-delay: 0.00s
    }

    .cell:nth-child(2) {
      animation-delay: 0.04s
    }

    .cell:nth-child(3) {
      animation-delay: 0.08s
    }

    .cell:nth-child(4) {
      animation-delay: 0.12s
    }

    .cell:nth-child(5) {
      animation-delay: 0.16s
    }

    .cell:nth-child(6) {
      animation-delay: 0.20s
    }

    .cell:nth-child(7) {
      animation-delay: 0.24s
    }

    .cell:nth-child(8) {
      animation-delay: 0.28s
    }

    .cell:nth-child(9) {
      animation-delay: 0.32s
    }

    @keyframes cellAppear {
      from {
        transform: scale(0.5) rotate(-8deg);
        opacity: 0
      }

      to {
        transform: scale(1) rotate(0);
        opacity: 1
      }
    }

    .cell:hover:not(.taken) {
      background: rgba(255, 255, 255, 0.055);
      transform: scale(1.05);
      border-color: rgba(255, 255, 255, 0.14);
      box-shadow: inset 0 0 20px rgba(255, 255, 255, 0.04);
    }

    @media(hover:none) {
      .cell:active:not(.taken) {
        background: rgba(255, 255, 255, 0.08);
        transform: scale(0.95);
      }
    }

    .cell:active:not(.taken) {
      transform: scale(0.95);
    }

    .cell.taken {
      cursor: default;
    }

    /* Ghost preview */
    .ghost-preview {
      position: absolute;
      width: 52%;
      height: 52%;
      opacity: 0.16;
      pointer-events: none;
      display: none;
    }

    .cell:not(.taken):hover .ghost-preview {
      display: block;
    }

    .cell.win-cell.x-cell {
      border-color: rgba(255, 77, 109, 0.8);
      box-shadow: var(--gx), inset 0 0 30px rgba(255, 77, 109, 0.15);
      animation: winCX 0.8s ease-in-out infinite alternate;
    }

    .cell.win-cell.o-cell {
      border-color: rgba(77, 255, 219, 0.8);
      box-shadow: var(--go), inset 0 0 30px rgba(77, 255, 219, 0.15);
      animation: winCO 0.8s ease-in-out infinite alternate;
    }

    @keyframes winCX {
      0% {
        transform: scale(1);
        background: rgba(255, 77, 109, 0.05)
      }

      100% {
        transform: scale(1.07);
        background: rgba(255, 77, 109, 0.14)
      }
    }

    @keyframes winCO {
      0% {
        transform: scale(1);
        background: rgba(77, 255, 219, 0.05)
      }

      100% {
        transform: scale(1.07);
        background: rgba(77, 255, 219, 0.14)
      }
    }

    @keyframes cellPlace {
      0% {
        transform: scale(0.55) rotate(6deg)
      }

      70% {
        transform: scale(1.08)
      }

      100% {
        transform: scale(1)
      }
    }

    .cell.just-placed {
      animation: cellPlace 0.35s cubic-bezier(.34, 1.56, .64, 1);
    }

    .ripple {
      position: absolute;
      border-radius: 50%;
      width: 12px;
      height: 12px;
      transform: scale(0) translate(-50%, -50%);
      opacity: 0.6;
      animation: rippleAnim 0.55s ease-out forwards;
      pointer-events: none;
      left: 50%;
      top: 50%;
    }

    @keyframes rippleAnim {
      to {
        transform: scale(16) translate(-50%, -50%);
        opacity: 0;
      }
    }

    .symbol {
      width: 52%;
      height: 52%;
    }

    .x-sym line {
      stroke: var(--x);
      stroke-width: 6.5;
      stroke-linecap: round;
      stroke-dasharray: 62;
      stroke-dashoffset: 62;
      filter: drop-shadow(0 0 6px var(--x)) drop-shadow(0 0 14px var(--x));
      animation: drawLine 0.28s cubic-bezier(.4, 0, .2, 1) forwards;
    }

    .x-sym line:nth-child(2) {
      animation-delay: 0.1s;
    }

    @keyframes drawLine {
      to {
        stroke-dashoffset: 0;
      }
    }

    .o-sym circle {
      stroke: var(--o);
      stroke-width: 6.5;
      stroke-linecap: round;
      fill: none;
      stroke-dasharray: 130;
      stroke-dashoffset: 130;
      filter: drop-shadow(0 0 6px var(--o)) drop-shadow(0 0 14px var(--o));
      animation: drawCircle 0.38s cubic-bezier(.4, 0, .2, 1) forwards;
    }

    @keyframes drawCircle {
      to {
        stroke-dashoffset: 0;
      }
    }

    .game-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }

    /* CHAT */
    #chat-col {
      display: flex;
      flex-direction: column;
      background: var(--s1);
      border: 1px solid rgba(255, 255, 255, 0.07);
      border-radius: 18px;
      overflow: hidden;
      height: clamp(320px, 58vh, 500px);
    }

    .chat-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--s2);
      font-size: 0.55rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      opacity: 0.35;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      scrollbar-width: thin;
      scrollbar-color: var(--s2) transparent;
    }

    .chat-messages::-webkit-scrollbar {
      width: 3px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: var(--s2);
      border-radius: 3px;
    }

    .chat-msg {
      font-size: 0.65rem;
      line-height: 1.45;
      animation: msgIn 0.2s ease both;
    }

    @keyframes msgIn {
      from {
        opacity: 0;
        transform: translateY(5px)
      }
    }

    .chat-msg-from {
      font-weight: 700;
      font-size: 0.52rem;
      letter-spacing: 0.1em;
      margin-bottom: 2px;
    }

    .chat-msg-from.me {
      color: var(--x)
    }

    .chat-msg-from.them {
      color: var(--o)
    }

    .chat-msg-from.sys {
      color: #444;
    }

    .chat-msg-text {
      opacity: 0.72;
    }

    .chat-msg-text.sys {
      opacity: 0.35;
      font-style: italic;
    }

    .chat-input-row {
      display: flex;
      border-top: 1px solid var(--s2);
    }

    .chat-input {
      flex: 1;
      font-family: 'Space Mono', monospace;
      font-size: 0.65rem;
      background: transparent;
      border: none;
      color: #fff;
      padding: 12px 14px;
      outline: none;
    }

    .chat-input::placeholder {
      opacity: 0.18;
    }

    .chat-send {
      font-family: 'Space Mono', monospace;
      font-size: 0.6rem;
      background: transparent;
      border: none;
      border-left: 1px solid var(--s2);
      color: rgba(255, 255, 255, 0.35);
      padding: 0 14px;
      cursor: pointer;
      transition: color 0.2s;
    }

    .chat-send:hover {
      color: #fff;
    }

    /* OVERLAY */
    #overlay {
      position: fixed;
      inset: 0;
      z-index: 30;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(5, 6, 14, 0.82);
      backdrop-filter: blur(12px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s;
      padding: 20px;
    }

    #overlay.show {
      opacity: 1;
      pointer-events: all;
    }

    .overlay-box {
      position: relative;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 28px;
      padding: clamp(32px, 8vw, 56px) clamp(28px, 6vw, 56px);
      text-align: center;
      width: min(360px, 92vw);
      transform: scale(0.75) translateY(20px);
      transition: transform 0.5s cubic-bezier(.34, 1.56, .64, 1);
      box-shadow: 0 40px 100px rgba(0, 0, 0, 0.6);
      overflow: hidden;
    }

    #overlay.show .overlay-box {
      transform: scale(1) translateY(0);
    }

    /* Shockwave rings */
    .ov-ring {
      position: absolute;
      border-radius: 50%;
      border: 2px solid;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%) scale(0);
      width: 100px;
      height: 100px;
      opacity: 0;
      pointer-events: none;
    }

    .ov-ring.x-ring {
      border-color: var(--x);
    }

    .ov-ring.o-ring {
      border-color: var(--o);
    }

    .ov-ring.d-ring {
      border-color: #888;
    }

    .ov-ring.go {
      animation: ringExpand 1.2s ease-out forwards;
    }

    .ov-ring:nth-child(2).go {
      animation-delay: 0.2s;
    }

    .ov-ring:nth-child(3).go {
      animation-delay: 0.4s;
    }

    @keyframes ringExpand {
      0% {
        transform: translate(-50%, -50%) scale(0);
        opacity: 0.9
      }

      100% {
        transform: translate(-50%, -50%) scale(6);
        opacity: 0;
      }
    }

    .ov-glow {
      position: absolute;
      width: 200px;
      height: 200px;
      border-radius: 50%;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      filter: blur(60px);
      opacity: 0;
      transition: opacity 0.6s;
      pointer-events: none;
    }

    #overlay.show .ov-glow {
      opacity: 0.28;
    }

    .overlay-emoji {
      font-size: clamp(2rem, 8vw, 2.8rem);
      margin-bottom: 12px;
      display: block;
      animation: emojiPop 0.6s cubic-bezier(.34, 1.56, .64, 1) 0.1s both;
    }

    @keyframes emojiPop {
      from {
        transform: scale(0) rotate(-20deg);
        opacity: 0
      }
    }

    .overlay-result {
      font-family: 'Orbitron', sans-serif;
      font-size: clamp(1.3rem, 6vw, 2.5rem);
      font-weight: 900;
      margin-bottom: 8px;
      position: relative;
      z-index: 1;
      animation: resultDrop 0.5s cubic-bezier(.34, 1.56, .64, 1) 0.15s both;
    }

    @keyframes resultDrop {
      from {
        transform: translateY(-20px) scale(0.8);
        opacity: 0
      }
    }

    .overlay-result.x-win {
      color: var(--x);
      text-shadow: 0 0 30px #ff4d6d, 0 0 80px #ff4d6d44;
    }

    .overlay-result.o-win {
      color: var(--o);
      text-shadow: 0 0 30px #4dffdb, 0 0 80px #4dffdb44;
    }

    .overlay-result.draw {
      color: #aaa;
    }

    .overlay-sub {
      font-size: clamp(0.55rem, 2.5vw, 0.6rem);
      letter-spacing: 0.35em;
      opacity: 0.3;
      margin-bottom: 8px;
      animation: resultDrop 0.5s cubic-bezier(.34, 1.56, .64, 1) 0.2s both;
    }

    .overlay-score {
      font-family: 'Orbitron', sans-serif;
      font-size: clamp(0.6rem, 2.5vw, 0.65rem);
      letter-spacing: 0.1em;
      opacity: 0.45;
      margin-bottom: 24px;
      animation: resultDrop 0.5s cubic-bezier(.34, 1.56, .64, 1) 0.25s both;
    }

    .overlay-rematch {
      font-size: clamp(0.55rem, 2.5vw, 0.6rem);
      color: var(--o);
      letter-spacing: 0.1em;
      min-height: 18px;
      margin-bottom: 12px;
      opacity: 0.7;
    }

    .overlay-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      animation: resultDrop 0.5s cubic-bezier(.34, 1.56, .64, 1) 0.3s both;
    }
  </style>
</head>

<body>

  <canvas id="canvas-bg"></canvas>
  <div class="aurora"></div>
  <div class="grid-deco"></div>
  <canvas id="fw-canvas"></canvas>
  <div id="screen-flash"></div>
  <div id="toast"></div>
  <div id="weather-badge"></div>

  <!-- AUTH -->
  <div id="screen-auth" class="screen active">
    <div style="display:flex;flex-direction:column;align-items:center;gap:28px">
      <div>
        <div class="brand">Tic ¬∑ Tac ¬∑ Toe</div>
        <div class="brand-sub">Real-time Multiplayer</div>
      </div>
      <div class="auth-box">
        <div class="tab-bar">
          <button class="tab-btn active" onclick="switchTab('login')">Sign In</button>
          <button class="tab-btn" onclick="switchTab('register')">Register</button>
        </div>
        <div class="auth-form" id="form-login">
          <div class="field-group">
            <div class="field-label">Username</div><input class="field-input" id="login-user" type="text"
              placeholder="your username" autocomplete="username" spellcheck="false">
          </div>
          <div class="field-group">
            <div class="field-label">Password</div><input class="field-input" id="login-pass" type="password"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
          </div>
          <div class="auth-error" id="login-error"></div>
          <button class="btn btn-primary" onclick="doLogin(this)">Sign In ‚Üí</button>
        </div>
        <div class="auth-form" id="form-register" style="display:none">
          <div class="field-group">
            <div class="field-label">Username <span style="opacity:0.35;font-size:0.5rem">(3‚Äì16 chars)</span></div>
            <input class="field-input" id="reg-user" type="text" placeholder="choose a username" autocomplete="username"
              spellcheck="false">
          </div>
          <div class="field-group">
            <div class="field-label">Password <span style="opacity:0.35;font-size:0.5rem">(min 8 chars)</span></div>
            <input class="field-input" id="reg-pass" type="password" placeholder="choose a password"
              autocomplete="new-password">
          </div>
          <div class="auth-error" id="reg-error"></div>
          <button class="btn btn-primary" onclick="doRegister(this)">Create Account ‚Üí</button>
        </div>
      </div>
    </div>
  </div>

  <!-- LOBBY -->
  <div id="screen-lobby" class="screen">
    <div style="display:flex;flex-direction:column;align-items:center;gap:18px;width:100%">
      <div class="lobby-top">
        <div class="brand" style="font-size:1.2rem;letter-spacing:0.2em">Tic ¬∑ Tac ¬∑ Toe</div>
        <div style="display:flex;align-items:center;gap:10px">
          <button class="icon-btn" onclick="openSpaceGallery()" title="Space Gallery">üåå</button>
          <div class="user-chip">
            <div class="user-avatar" id="lobby-avatar">?</div>
            <div class="user-name" id="lobby-username">‚Äì</div>
          </div>
          <button class="logout-btn" onclick="doLogout()">Logout</button>
        </div>
      </div>
      <div style="display:flex;gap:8px">
        <div class="stat-pill w">W: <span id="stat-w">0</span></div>
        <div class="stat-pill d">D: <span id="stat-d">0</span></div>
        <div class="stat-pill l">L: <span id="stat-l">0</span></div>
      </div>
      <div class="lobby-card">
        <div class="lobby-section">
          <div class="lobby-section-title">‚öî Online Multiplayer</div>
          <div class="lobby-modes">
            <button class="big-btn big-btn-create" onclick="createRoom()"><span>+</span> Create Room</button>
            <div style="display:flex;flex-direction:column;gap:8px">
              <div class="join-row">
                <input class="join-input" id="join-code" maxlength="4" placeholder="CODE" spellcheck="false">
                <button class="btn-join" onclick="joinRoom()">Join ‚Üí</button>
              </div>
              <div class="lobby-error" id="lobby-error"></div>
            </div>
          </div>
        </div>
        <div class="lobby-section">
          <div class="lobby-section-title">ü§ñ Solo Play</div>
          <button class="big-btn big-btn-ai" onclick="startAI()">Play vs AI</button>
        </div>
      </div>
    </div>
  </div>

  <!-- WAITING -->
  <div id="screen-waiting" class="screen">
    <div class="waiting-card">
      <div class="waiting-title">Waiting for opponent</div>
      <div class="room-code-display" id="waiting-code">XXXX</div>
      <div class="room-code-label">Share this code with your friend</div>
      <button class="copy-btn" id="copy-btn" onclick="copyCode()">üìã Copy Code</button>
      <div class="waiting-dots"><span></span><span></span><span></span></div>
    </div>
    <button class="btn" style="margin-top:18px" onclick="cancelWaiting()">‚Üê Back to Lobby</button>
  </div>

  <!-- GAME -->
  <div id="screen-game" class="screen">
    <div class="game-layout">
      <div class="player-panel" id="panel-x">
        <div class="pp-symbol x">X</div>
        <div class="pp-name" id="name-x">Player X</div>
        <div class="pp-role" id="role-x">Player</div>
        <div class="pp-score" id="score-x">0</div>
        <div class="pp-turn">
          <div class="pp-turn-dot"></div><span>Your turn</span>
        </div>
      </div>
      <div class="game-col">
        <div class="game-title-mini">Tic ¬∑ Tac ¬∑ Toe</div>
        <div class="game-scores">
          <div class="gs-card" id="gsc-x">
            <div class="gs-val" style="color:var(--x)" id="gs-x">0</div>
            <div class="gs-label">X</div>
          </div>
          <div class="gs-sep">‚Äì</div>
          <div class="gs-card" id="gsc-d">
            <div class="gs-val" style="color:#444" id="gs-d">0</div>
            <div class="gs-label">D</div>
          </div>
          <div class="gs-sep">‚Äì</div>
          <div class="gs-card" id="gsc-o">
            <div class="gs-val" style="color:var(--o)" id="gs-o">0</div>
            <div class="gs-label">O</div>
          </div>
        </div>
        <div id="game-status">
          <span class="status-dot" id="status-dot" style="background:#fff"></span>
          <span id="status-text">‚Äì</span>
        </div>
        <div id="board-wrap">
          <div id="board"></div>
          <canvas id="win-canvas"></canvas>
        </div>
        <div class="game-actions">
          <button class="btn" id="btn-leave" onclick="leaveGame()">‚Üê Leave</button>
          <button class="btn" id="btn-new-ai" onclick="newAIGame()" style="display:none">New Game</button>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:12px">
        <div class="player-panel" id="panel-o">
          <div class="pp-symbol o">O</div>
          <div class="pp-name" id="name-o">Player O</div>
          <div class="pp-role" id="role-o">Player</div>
          <div class="pp-score" id="score-o">0</div>
          <div class="pp-turn">
            <div class="pp-turn-dot"></div><span>Your turn</span>
          </div>
        </div>
        <div id="chat-col">
          <div class="chat-header">üí¨ Chat</div>
          <div class="chat-messages" id="chat-messages"></div>
          <div class="chat-input-row">
            <input class="chat-input" id="chat-input" placeholder="Say something‚Ä¶" maxlength="120">
            <button class="chat-send" onclick="sendChat()">Send</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SPACE GALLERY -->
  <div id="screen-space" class="screen">
    <div class="space-gallery-container">
      <div class="space-header">
        <button class="btn" onclick="closeSpaceGallery()">‚Üê Back</button>
        <h2 class="space-title">üåå Space Explorer</h2>
        <div class="space-tabs">
          <button class="space-tab active" onclick="switchSpaceTab('solar')">Solar System</button>
          <button class="space-tab" onclick="switchSpaceTab('stars')">Nearby Stars</button>
          <button class="space-tab" onclick="switchSpaceTab('nebulae')">Nebulae</button>
        </div>
      </div>
      <div class="space-canvas-wrap">
        <canvas id="space-canvas"></canvas>
        <div id="space-info" class="space-info"></div>
        <div class="space-controls">
          <div class="space-control-group">
            <span class="space-control-label">Zoom</span>
            <input type="range" id="zoom-slider" min="0.5" max="3" step="0.1" value="1">
          </div>
          <div class="space-control-group">
            <span class="space-control-label">Speed</span>
            <input type="range" id="speed-slider" min="0" max="5" step="0.5" value="1">
          </div>
          <button class="btn-small" onclick="resetSpaceView()">Reset View</button>
        </div>
      </div>
      <div class="space-sidebar">
        <h3 class="space-sidebar-title">Objects</h3>
        <div id="space-objects-list" class="space-objects-list"></div>
      </div>
    </div>
  </div>

  <!-- OVERLAY -->
  <div id="overlay">
    <div class="overlay-box">
      <div class="ov-ring" id="ov-r1"></div>
      <div class="ov-ring" id="ov-r2"></div>
      <div class="ov-ring" id="ov-r3"></div>
      <div class="ov-glow" id="ov-glow"></div>
      <span class="overlay-emoji" id="ov-emoji">üéâ</span>
      <div class="overlay-result" id="ov-result">X Wins!</div>
      <div class="overlay-sub" id="ov-sub">VICTORY</div>
      <div class="overlay-score" id="ov-score"></div>
      <div class="overlay-rematch" id="ov-rematch"></div>
      <div class="overlay-actions" id="ov-actions"></div>
    </div>
  </div>

  <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // DYNAMIC BACKGROUND SYSTEM
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let bgMode = 'space', weatherData = null;

    // Get user location and weather
    (async function initBg() {
      try {
        const pos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej, { timeout: 5000 }));
        const { latitude: lat, longitude: lon } = pos.coords;
        const w = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`).then(r => r.json());
        weatherData = w.current_weather;
        const code = weatherData.weathercode;
        if ([71, 73, 75, 77, 85, 86].includes(code)) bgMode = 'snow';
        else if ([51, 53, 55, 61, 63, 65, 80, 81, 82].includes(code)) bgMode = 'rain';
        else if ([95, 96, 99].includes(code)) bgMode = 'storm';
        else if (weatherData.cloudcover > 70) bgMode = 'cloudy';
        else bgMode = 'space';
      } catch (e) { bgMode = 'space'; }
      initBackground();
    })();

    function initBackground() {
      const badge = document.getElementById('weather-badge');
      const icons = { space: 'üåå', rain: 'üåßÔ∏è', snow: '‚ùÑÔ∏è', storm: '‚õàÔ∏è', cloudy: '‚òÅÔ∏è' };
      const labels = { space: 'Deep Space', rain: 'Rainy', snow: 'Snowy', storm: 'Stormy', cloudy: 'Cloudy' };
      badge.textContent = `${icons[bgMode]} ${labels[bgMode]}`;
      badge.classList.add('show');

      if (bgMode === 'space') initSpace();
      else if (bgMode === 'rain') initRain();
      else if (bgMode === 'snow') initSnow();
      else if (bgMode === 'storm') initStorm();
      else if (bgMode === 'cloudy') initCloudy();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SPACE MODE - Enhanced realistic space
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function initSpace() {
      const cv = document.getElementById('canvas-bg'), ctx = cv.getContext('2d');
      let stars = [], nebulae = [], planets = [], shooters = [];

      function resize() {
        cv.width = innerWidth; cv.height = innerHeight;
        // Stars - multiple layers with varied sizes
        stars = Array.from({ length: 400 }, () => ({
          x: Math.random() * cv.width,
          y: Math.random() * cv.height,
          r: Math.random() * 1.8 + 0.3,
          op: Math.random() * 0.9 + 0.1,
          spd: Math.random() * 0.2 + 0.05,
          t: Math.random() * Math.PI * 2,
          layer: Math.random(),
          color: ['#ffffff', '#ffe9d5', '#d4e4ff', '#fff4e8'][Math.floor(Math.random() * 4)]
        }));
        // Nebula clouds - more realistic
        nebulae = Array.from({ length: 8 }, () => ({
          x: Math.random() * cv.width,
          y: Math.random() * cv.height,
          r: 150 + Math.random() * 300,
          color: `hsl(${Math.random() * 60 + 200},${40 + Math.random() * 30}%,${20 + Math.random() * 15}%)`,
          op: 0.08 + Math.random() * 0.08,
          drift: Math.random() * 0.03,
          rotation: Math.random() * Math.PI * 2
        }));
        // Distant planets with realistic textures
        planets = Array.from({ length: 3 }, () => ({
          x: Math.random() * cv.width,
          y: Math.random() * cv.height * 0.7,
          r: 25 + Math.random() * 50,
          color: `hsl(${Math.random() * 360},${30 + Math.random() * 20}%,${40 + Math.random() * 20}%)`,
          rings: Math.random() > 0.6,
          craters: Math.random() > 0.5,
          atmosphere: Math.random() > 0.7
        }));
      }

      // Shooting stars
      setInterval(() => {
        if (Math.random() < 0.3) shooters.push({
          x: Math.random() * cv.width * 0.8,
          y: Math.random() * cv.height * 0.4,
          vx: 5 + Math.random() * 8,
          vy: 3 + Math.random() * 5,
          life: 1,
          len: 80 + Math.random() * 120,
          brightness: 0.8 + Math.random() * 0.2
        });
      }, 2500);

      function draw() {
        ctx.fillStyle = 'rgba(5,6,14,0.2)'; ctx.fillRect(0, 0, cv.width, cv.height);

        // Limit updates for performance
        const now = Date.now();
        if (!draw.lastUpdate) draw.lastUpdate = now;
        const delta = (now - draw.lastUpdate) / 16.67; // 60fps baseline
        draw.lastUpdate = now;
        if (draw.frame === undefined) draw.frame = 0;
        draw.frame++;

        // Nebulae (update every other frame)
        if (draw.frame % 2 === 0) {
          nebulae.forEach(n => {
            n.x += n.drift * delta; if (n.x > cv.width + n.r) n.x = -n.r;
            n.rotation += 0.0002 * delta;
            ctx.save();
            ctx.translate(n.x, n.y);
            ctx.rotate(n.rotation);
            const g = ctx.createRadialGradient(0, 0, 0, 0, 0, n.r);
            g.addColorStop(0, n.color.replace('%)', `%,${n.op})`));
            g.addColorStop(0.5, n.color.replace('%)', `%,${n.op * 0.5})`));
            g.addColorStop(1, 'transparent');
            ctx.fillStyle = g;
            ctx.fillRect(-n.r, -n.r, n.r * 2, n.r * 2);
            ctx.restore();
          });

          // Planets with realistic 3D sphere rendering
          planets.forEach(p => {
            const ctx = this.ctx;

            // Create realistic 3D sphere using multiple gradient layers
            // Base sphere with terminator (day/night boundary)
            const lightAngle = -Math.PI / 4; // Light from top-left
            const lightX = p.x + Math.cos(lightAngle) * p.r * 0.5;
            const lightY = p.y + Math.sin(lightAngle) * p.r * 0.5;

            // Main sphere gradient (lit side)
            const mainG = ctx.createRadialGradient(lightX, lightY, 0, p.x, p.y, p.r);
            mainG.addColorStop(0, p.color.replace(/hsl\((\d+),\s*(\d+)%,\s*(\d+)%\)/, (m, h, s, l) => `hsl(${h},${s}%,${Math.min(95, parseInt(l) + 40)}%)`));
            mainG.addColorStop(0.25, p.color.replace(/hsl\((\d+),\s*(\d+)%,\s*(\d+)%\)/, (m, h, s, l) => `hsl(${h},${s}%,${Math.min(85, parseInt(l) + 20)}%)`));
            mainG.addColorStop(0.5, p.color);
            mainG.addColorStop(0.75, p.color.replace(/hsl\((\d+),\s*(\d+)%,\s*(\d+)%\)/, (m, h, s, l) => `hsl(${h},${Math.max(20, parseInt(s) - 10)}%,${Math.max(15, parseInt(l) - 20)}%)`));
            mainG.addColorStop(1, p.color.replace(/hsl\((\d+),\s*(\d+)%,\s*(\d+)%\)/, (m, h, s, l) => `hsl(${h},${Math.max(10, parseInt(s) - 20)}%,${Math.max(5, parseInt(l) - 35)}%)`));

            ctx.fillStyle = mainG;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
            ctx.fill();

            // Terminator shadow (creates 3D sphere effect)
            const shadowAngle = lightAngle + Math.PI;
            const shadowX = p.x + Math.cos(shadowAngle) * p.r * 0.3;
            const shadowY = p.y + Math.sin(shadowAngle) * p.r * 0.3;
            const termG = ctx.createRadialGradient(shadowX, shadowY, p.r * 0.3, shadowX, shadowY, p.r * 1.2);
            termG.addColorStop(0, 'rgba(0,0,0,0.7)');
            termG.addColorStop(0.5, 'rgba(0,0,0,0.4)');
            termG.addColorStop(0.8, 'rgba(0,0,0,0.1)');
            termG.addColorStop(1, 'rgba(0,0,0,0)');

            ctx.fillStyle = termG;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
            ctx.fill();

            // Specular highlight (makes it look glossy/3D)
            const specG = ctx.createRadialGradient(lightX, lightY, 0, lightX, lightY, p.r * 0.4);
            specG.addColorStop(0, 'rgba(255,255,255,0.3)');
            specG.addColorStop(0.5, 'rgba(255,255,255,0.1)');
            specG.addColorStop(1, 'rgba(255,255,255,0)');

            ctx.fillStyle = specG;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
            ctx.fill();

            // Atmosphere glow
            if (p.atmosphere) {
              const atmG = ctx.createRadialGradient(p.x, p.y, p.r * 0.9, p.x, p.y, p.r * 1.3);
              atmG.addColorStop(0, 'transparent');
              atmG.addColorStop(0.5, baseColor.replace('%)', `%,${30}%,0.15)`));
              atmG.addColorStop(1, 'transparent');
              ctx.fillStyle = atmG;
              ctx.beginPath(); ctx.arc(p.x, p.y, p.r * 1.3, 0, Math.PI * 2); ctx.fill();
            }

            // Rings
            if (p.rings) {
              ctx.save();
              ctx.globalAlpha = 0.6;
              const ringG = ctx.createLinearGradient(p.x - p.r * 2.5, p.y, p.x + p.r * 2.5, p.y);
              ringG.addColorStop(0, 'transparent');
              ringG.addColorStop(0.3, baseColor.replace('%)', `%,${50}%)`));
              ringG.addColorStop(0.5, baseColor.replace('%)', `%,${60}%)`));
              ringG.addColorStop(0.7, baseColor.replace('%)', `%,${50}%)`));
              ringG.addColorStop(1, 'transparent');
              ctx.strokeStyle = ringG;
              ctx.lineWidth = p.r * 0.5;
              ctx.beginPath(); ctx.ellipse(p.x, p.y, p.r * 2.2, p.r * 0.6, 0, 0, Math.PI * 2); ctx.stroke();
              // Ring shadow on planet
              ctx.globalAlpha = 0.3;
              ctx.fillStyle = 'rgba(0,0,0,0.5)';
              ctx.beginPath(); ctx.ellipse(p.x, p.y - p.r * 0.3, p.r * 0.9, p.r * 0.15, 0, 0, Math.PI); ctx.fill();
              ctx.restore();
            }
          });

          // Stars with realistic colors and twinkle
          stars.forEach(s => {
            s.t += 0.008 * s.spd; s.x -= s.layer * 0.08; if (s.x < -10) s.x = cv.width + 10;
            const twinkle = 0.3 + 0.7 * Math.sin(s.t);
            const a = s.op * twinkle;
            const sz = s.r * (0.85 + 0.3 * Math.sin(s.t * 1.5));

            // Star glow
            const g = ctx.createRadialGradient(s.x, s.y, 0, s.x, s.y, sz * 3);
            g.addColorStop(0, s.color);
            g.addColorStop(0.3, s.color.replace(')', `,${a * 0.6})`));
            g.addColorStop(1, 'transparent');
            ctx.fillStyle = g;
            ctx.beginPath(); ctx.arc(s.x, s.y, sz * 3, 0, Math.PI * 2); ctx.fill();

            // Star core
            ctx.fillStyle = s.color;
            ctx.globalAlpha = a;
            ctx.beginPath(); ctx.arc(s.x, s.y, sz, 0, Math.PI * 2); ctx.fill();
            ctx.globalAlpha = 1;

            // Bright twinkle
            if (Math.sin(s.t) > 0.85) {
              ctx.shadowBlur = 12; ctx.shadowColor = s.color;
              ctx.fillStyle = '#fff';
              ctx.beginPath(); ctx.arc(s.x, s.y, sz * 0.5, 0, Math.PI * 2); ctx.fill();
              ctx.shadowBlur = 0;
            }
          });

          // Shooting stars with realistic trails
          shooters = shooters.filter(s => s.life > 0);
          shooters.forEach(s => {
            // Trail gradient
            const g = ctx.createLinearGradient(s.x, s.y, s.x - s.vx * s.len / 4, s.y - s.vy * s.len / 4);
            g.addColorStop(0, `rgba(255,255,255,${s.life * s.brightness})`);
            g.addColorStop(0.3, `rgba(200,220,255,${s.life * s.brightness * 0.6})`);
            g.addColorStop(0.7, `rgba(150,180,255,${s.life * s.brightness * 0.3})`);
            g.addColorStop(1, 'transparent');

            // Outer glow
            ctx.strokeStyle = `rgba(200,220,255,${s.life * 0.3})`;
            ctx.lineWidth = 4;
            ctx.lineCap = 'round';
            ctx.beginPath();
            ctx.moveTo(s.x, s.y);
            ctx.lineTo(s.x - s.vx * s.len / 4, s.y - s.vy * s.len / 4);
            ctx.stroke();

            // Main trail
            ctx.strokeStyle = g;
            ctx.lineWidth = 2.5;
            ctx.beginPath();
            ctx.moveTo(s.x, s.y);
            ctx.lineTo(s.x - s.vx * s.len / 4, s.y - s.vy * s.len / 4);
            ctx.stroke();

            // Bright head
            ctx.shadowBlur = 15;
            ctx.shadowColor = '#fff';
            ctx.fillStyle = `rgba(255,255,255,${s.life})`;
            ctx.beginPath(); ctx.arc(s.x, s.y, 2.5, 0, Math.PI * 2); ctx.fill();
            ctx.shadowBlur = 0;

            // Sparkles
            if (Math.random() < 0.3) {
              const sx = s.x - s.vx * Math.random() * s.len / 5;
              const sy = s.y - s.vy * Math.random() * s.len / 5;
              ctx.fillStyle = `rgba(255,255,255,${s.life * 0.6})`;
              ctx.beginPath(); ctx.arc(sx, sy, 1, 0, Math.PI * 2); ctx.fill();
            }

            s.x += s.vx; s.y += s.vy; s.life -= 0.018;
          });

          requestAnimationFrame(draw);
        }

        resize(); draw(); addEventListener('resize', resize);
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // RAIN MODE
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      function initRain() {
        const cv = document.getElementById('canvas-bg'), ctx = cv.getContext('2d');
        let drops = [];
        cv.width = innerWidth; cv.height = innerHeight;

        for (let i = 0; i < 150; i++)drops.push({
          x: Math.random() * cv.width,
          y: Math.random() * cv.height,
          l: 10 + Math.random() * 20,
          spd: 8 + Math.random() * 8,
          op: 0.3 + Math.random() * 0.4
        });

        function draw() {
          ctx.fillStyle = 'rgba(15,20,35,0.1)'; ctx.fillRect(0, 0, cv.width, cv.height);
          drops.forEach(d => {
            d.y += d.spd; d.x += 1;
            if (d.y > cv.height) { d.y = -20; d.x = Math.random() * cv.width; }
            ctx.strokeStyle = `rgba(150,180,220,${d.op})`; ctx.lineWidth = 1.5;
            ctx.beginPath(); ctx.moveTo(d.x, d.y); ctx.lineTo(d.x + 2, d.y + d.l); ctx.stroke();
          });
          requestAnimationFrame(draw);
        }
        draw();
        document.querySelector('.aurora').style.background = 'radial-gradient(ellipse at 50% 50%,rgba(100,120,180,0.15),transparent)';
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // SNOW MODE
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      function initSnow() {
        const cv = document.getElementById('canvas-bg'), ctx = cv.getContext('2d');
        let flakes = [];
        cv.width = innerWidth; cv.height = innerHeight;

        for (let i = 0; i < 200; i++)flakes.push({
          x: Math.random() * cv.width,
          y: Math.random() * cv.height,
          r: 2 + Math.random() * 4,
          spd: 1 + Math.random() * 2,
          drift: Math.random() * 2 - 1,
          op: 0.5 + Math.random() * 0.5
        });

        function draw() {
          ctx.fillStyle = 'rgba(20,25,40,0.05)'; ctx.fillRect(0, 0, cv.width, cv.height);
          flakes.forEach(f => {
            f.y += f.spd; f.x += f.drift;
            if (f.y > cv.height) { f.y = -10; f.x = Math.random() * cv.width; }
            if (f.x < 0 || f.x > cv.width) f.x = Math.random() * cv.width;
            ctx.fillStyle = `rgba(255,255,255,${f.op})`;
            ctx.beginPath(); ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2); ctx.fill();
            ctx.shadowBlur = 4; ctx.shadowColor = '#fff';
            ctx.beginPath(); ctx.arc(f.x, f.y, f.r * 0.5, 0, Math.PI * 2); ctx.fill();
            ctx.shadowBlur = 0;
          });
          requestAnimationFrame(draw);
        }
        draw();
        document.querySelector('.aurora').style.background = 'radial-gradient(ellipse at 50% 30%,rgba(180,200,255,0.2),transparent)';
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // STORM MODE
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      function initStorm() {
        const cv = document.getElementById('canvas-bg'), ctx = cv.getContext('2d');
        let drops = [], lightning = [];
        cv.width = innerWidth; cv.height = innerHeight;

        for (let i = 0; i < 200; i++)drops.push({
          x: Math.random() * cv.width,
          y: Math.random() * cv.height,
          l: 15 + Math.random() * 25,
          spd: 12 + Math.random() * 12,
          op: 0.4 + Math.random() * 0.4
        });

        setInterval(() => {
          if (Math.random() < 0.1) lightning.push({ t: 0, x: Math.random() * cv.width });
        }, 2000);

        function draw() {
          ctx.fillStyle = 'rgba(10,10,20,0.15)'; ctx.fillRect(0, 0, cv.width, cv.height);

          // Lightning
          lightning = lightning.filter(l => l.t < 10);
          lightning.forEach(l => {
            l.t++;
            const op = 1 - l.t / 10;
            ctx.strokeStyle = `rgba(200,220,255,${op})`; ctx.lineWidth = 3;
            ctx.shadowBlur = 20; ctx.shadowColor = '#aaf';
            ctx.beginPath(); ctx.moveTo(l.x, 0);
            for (let i = 0; i < 5; i++) {
              l.x += Math.random() * 40 - 20;
              ctx.lineTo(l.x, i * cv.height / 5);
            }
            ctx.stroke(); ctx.shadowBlur = 0;
            if (l.t === 1) document.getElementById('screen-flash').style.background = 'rgba(200,220,255,0.3)';
          });

          // Heavy rain
          drops.forEach(d => {
            d.y += d.spd; d.x += 3;
            if (d.y > cv.height) { d.y = -20; d.x = Math.random() * cv.width; }
            ctx.strokeStyle = `rgba(130,150,200,${d.op})`; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.moveTo(d.x, d.y); ctx.lineTo(d.x + 3, d.y + d.l); ctx.stroke();
          });
          requestAnimationFrame(draw);
        }
        draw();
        document.querySelector('.aurora').style.background = 'radial-gradient(ellipse at 50% 20%,rgba(80,80,120,0.3),transparent)';
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // CLOUDY MODE
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      function initCloudy() {
        const cv = document.getElementById('canvas-bg'), ctx = cv.getContext('2d');
        let clouds = [];
        cv.width = innerWidth; cv.height = innerHeight;

        for (let i = 0; i < 8; i++)clouds.push({
          x: Math.random() * cv.width,
          y: Math.random() * cv.height * 0.6,
          w: 100 + Math.random() * 200,
          h: 40 + Math.random() * 60,
          spd: 0.2 + Math.random() * 0.3,
          op: 0.1 + Math.random() * 0.15
        });

        function draw() {
          ctx.fillStyle = 'rgba(30,35,50,0.02)'; ctx.fillRect(0, 0, cv.width, cv.height);
          clouds.forEach(c => {
            c.x += c.spd; if (c.x > cv.width + c.w) c.x = -c.w;
            ctx.fillStyle = `rgba(200,210,230,${c.op})`;
            ctx.beginPath();
            ctx.ellipse(c.x, c.y, c.w, c.h, 0, 0, Math.PI * 2);
            ctx.fill();
          });
          requestAnimationFrame(draw);
        }
        draw();
        document.querySelector('.aurora').style.background = 'radial-gradient(ellipse at 50% 40%,rgba(150,160,200,0.15),transparent)';
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // SHOOTING STARS (for space mode only)
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // SPACE GALLERY - Interactive 3D Space Explorer
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      const SpaceGallery = { canvas: null, ctx: null, objects: [], currentTab: 'solar', zoom: 1, speed: 1, rotation: 0, dragStart: null, offset: { x: 0, y: 0 }, hoveredObj: null, selectedObj: null, solarSystem: [{ name: 'Sun', type: 'Star', radius: 20, distance: 0, color: '#FDB813', temp: '5778K', mass: '1.989√ó10¬≥‚Å∞ kg' }, { name: 'Mercury', type: 'Planet', radius: 4, distance: 80, color: '#8C7853', orbit: 0.24, temp: '167¬∞C', moons: 0 }, { name: 'Venus', type: 'Planet', radius: 9, distance: 120, color: '#FFC649', orbit: 0.62, temp: '464¬∞C', moons: 0 }, { name: 'Earth', type: 'Planet', radius: 10, distance: 170, color: '#4A90E2', orbit: 1, temp: '15¬∞C', moons: 1 }, { name: 'Mars', type: 'Planet', radius: 5, distance: 220, color: '#E27B58', orbit: 1.88, temp: '-65¬∞C', moons: 2 }, { name: 'Jupiter', type: 'Planet', radius: 18, distance: 300, color: '#C88B3A', orbit: 11.86, temp: '-110¬∞C', moons: 79 }, { name: 'Saturn', type: 'Planet', radius: 16, distance: 380, color: '#FAD5A5', orbit: 29.46, temp: '-140¬∞C', moons: 82, rings: true }, { name: 'Uranus', type: 'Planet', radius: 12, distance: 450, color: '#4FD0E7', orbit: 84.01, temp: '-195¬∞C', moons: 27 }, { name: 'Neptune', type: 'Planet', radius: 12, distance: 510, color: '#4166F5', orbit: 164.79, temp: '-200¬∞C', moons: 14 }], nearbyStars: [{ name: 'Proxima Centauri', type: 'Red Dwarf', distance: 4.24, color: '#FF6B6B', temp: '3042K', mass: '0.12 M‚òâ' }, { name: 'Alpha Centauri A', type: 'G-type Star', distance: 4.37, color: '#FFF4E6', temp: '5790K', mass: '1.1 M‚òâ' }, { name: 'Alpha Centauri B', type: 'K-type Star', distance: 4.37, color: '#FFE4B5', temp: '5260K', mass: '0.9 M‚òâ' }, { name: "Barnard's Star", type: 'Red Dwarf', distance: 5.96, color: '#FF8C8C', temp: '3134K', mass: '0.14 M‚òâ' }, { name: 'Wolf 359', type: 'Red Dwarf', distance: 7.86, color: '#FF7777', temp: '2800K', mass: '0.09 M‚òâ' }, { name: 'Sirius A', type: 'A-type Star', distance: 8.6, color: '#E8F4FF', temp: '9940K', mass: '2.02 M‚òâ' }, { name: 'Sirius B', type: 'White Dwarf', distance: 8.6, color: '#FFFFFF', temp: '25200K', mass: '1.02 M‚òâ' }, { name: 'Luyten 726-8', type: 'Red Dwarf', distance: 8.73, color: '#FF9999', temp: '2670K', mass: '0.1 M‚òâ' }], nebulae: [{ name: 'Orion Nebula', type: 'Emission Nebula', distance: 1344, color: '#FF6B9D', size: 24, constellation: 'Orion' }, { name: 'Crab Nebula', type: 'Supernova Remnant', distance: 6500, color: '#4ECDC4', size: 11, constellation: 'Taurus' }, { name: 'Ring Nebula', type: 'Planetary Nebula', distance: 2300, color: '#95E1D3', size: 1.4, constellation: 'Lyra' }, { name: 'Eagle Nebula', type: 'Emission Nebula', distance: 7000, color: '#F38181', size: 70, constellation: 'Serpens' }, { name: 'Helix Nebula', type: 'Planetary Nebula', distance: 650, color: '#AA96DA', size: 2.5, constellation: 'Aquarius' }, { name: 'Horsehead Nebula', type: 'Dark Nebula', distance: 1500, color: '#5D5D5D', size: 3.5, constellation: 'Orion' }], init() { this.canvas = document.getElementById('space-canvas'); this.ctx = this.canvas.getContext('2d'); this.resize(); this.loadTab('solar'); this.canvas.addEventListener('mousedown', e => this.onDragStart(e)); this.canvas.addEventListener('mousemove', e => this.onDrag(e)); this.canvas.addEventListener('mouseup', () => this.onDragEnd()); this.canvas.addEventListener('mouseleave', () => this.onDragEnd()); this.canvas.addEventListener('wheel', e => this.onWheel(e)); this.canvas.addEventListener('click', e => this.onClick(e)); document.getElementById('zoom-slider').addEventListener('input', e => this.zoom = parseFloat(e.target.value)); document.getElementById('speed-slider').addEventListener('input', e => this.speed = parseFloat(e.target.value)); window.addEventListener('resize', () => this.resize()); this.animate(); }, resize() { const rect = this.canvas.parentElement.getBoundingClientRect(); this.canvas.width = rect.width; this.canvas.height = rect.height; }, loadTab(tab) { this.currentTab = tab; this.selectedObj = null; this.offset = { x: 0, y: 0 }; this.rotation = 0; document.querySelectorAll('.space-tab').forEach((t, i) => t.classList.toggle('active', ['solar', 'stars', 'nebulae'][i] === tab)); if (tab === 'solar') this.objects = this.solarSystem.map((o, i) => ({ ...o, angle: Math.random() * Math.PI * 2, id: i })); else if (tab === 'stars') this.objects = this.nearbyStars.map((o, i) => ({ ...o, x: Math.random() * 400 - 200, y: Math.random() * 400 - 200, z: Math.random() * 200 - 100, id: i })); else this.objects = this.nebulae.map((o, i) => ({ ...o, x: Math.random() * 500 - 250, y: Math.random() * 500 - 250, z: Math.random() * 150 - 75, id: i })); this.updateObjectsList(); }, updateObjectsList() { const list = document.getElementById('space-objects-list'); list.innerHTML = this.objects.map(o => `<div class="space-object-item" onclick="SpaceGallery.focusObject(${o.id})"><div class="space-object-name">${o.name}</div><div class="space-object-type">${o.type}</div></div>`).join(''); }, focusObject(id) { this.selectedObj = this.objects.find(o => o.id === id); document.querySelectorAll('.space-object-item').forEach((el, i) => el.classList.toggle('active', i === id)); this.showInfo(this.selectedObj); }, showInfo(obj) { if (!obj) return document.getElementById('space-info').classList.remove('show'); const info = document.getElementById('space-info'); let html = `<div class="space-info-name">${obj.name}</div><div class="space-info-type">${obj.type}</div><div class="space-info-data">`; if (obj.temp) html += `Temperature: ${obj.temp}<br>`; if (obj.mass) html += `Mass: ${obj.mass}<br>`; if (obj.distance !== undefined && this.currentTab === 'solar') html += `Distance: ${obj.distance}M km<br>`; if (obj.distance && this.currentTab !== 'solar') html += `Distance: ${obj.distance} ly<br>`; if (obj.orbit) html += `Orbital Period: ${obj.orbit} years<br>`; if (obj.moons !== undefined) html += `Moons: ${obj.moons}<br>`; if (obj.size) html += `Size: ${obj.size} ly<br>`; if (obj.constellation) html += `Constellation: ${obj.constellation}`; html += `</div>`; info.innerHTML = html; info.classList.add('show'); }, onDragStart(e) { this.dragStart = { x: e.clientX - this.offset.x, y: e.clientY - this.offset.y }; }, onDrag(e) { if (this.dragStart) { this.offset.x = e.clientX - this.dragStart.x; this.offset.y = e.clientY - this.dragStart.y; } this.checkHover(e); }, onDragEnd() { this.dragStart = null; }, onWheel(e) { e.preventDefault(); this.zoom = Math.max(0.5, Math.min(3, this.zoom - (e.deltaY * 0.001))); document.getElementById('zoom-slider').value = this.zoom; }, onClick(e) { if (this.hoveredObj) this.focusObject(this.hoveredObj.id); }, checkHover(e) { const rect = this.canvas.getBoundingClientRect(); const mx = e.clientX - rect.left, my = e.clientY - rect.top; this.hoveredObj = null; for (const obj of this.objects) { const pos = this.getScreenPos(obj); const dist = Math.sqrt((mx - pos.x) ** 2 + (my - pos.y) ** 2); if (dist < (obj.radius || 15) * this.zoom) { this.hoveredObj = obj; this.canvas.style.cursor = 'pointer'; return; } } this.canvas.style.cursor = this.dragStart ? 'grabbing' : 'grab'; }, getScreenPos(obj) { const cx = this.canvas.width / 2 + this.offset.x; const cy = this.canvas.height / 2 + this.offset.y; if (this.currentTab === 'solar') { const angle = obj.angle + (obj.orbit ? this.rotation * obj.orbit : 0); return { x: cx + Math.cos(angle) * obj.distance * this.zoom, y: cy + Math.sin(angle) * obj.distance * this.zoom }; } else { const rotX = obj.x * Math.cos(this.rotation) - obj.z * Math.sin(this.rotation); const rotZ = obj.x * Math.sin(this.rotation) + obj.z * Math.cos(this.rotation); return { x: cx + rotX * this.zoom, y: cy + obj.y * this.zoom, z: rotZ }; } }, animate() { this.ctx.fillStyle = 'rgba(5,6,14,0.3)'; this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height); this.rotation += 0.001 * this.speed; const sorted = [...this.objects].sort((a, b) => { const pa = this.getScreenPos(a), pb = this.getScreenPos(b); return (pb.z || 0) - (pa.z || 0); }); sorted.forEach(obj => { const pos = this.getScreenPos(obj); const r = (obj.radius || 15) * this.zoom; const isHovered = this.hoveredObj === obj; const isSelected = this.selectedObj === obj; if (this.currentTab === 'solar' && obj.distance > 0) { this.ctx.strokeStyle = 'rgba(255,255,255,0.05)'; this.ctx.lineWidth = 1; this.ctx.beginPath(); this.ctx.arc(this.canvas.width / 2 + this.offset.x, this.canvas.height / 2 + this.offset.y, obj.distance * this.zoom, 0, Math.PI * 2); this.ctx.stroke(); } if (isHovered || isSelected) { const g = this.ctx.createRadialGradient(pos.x, pos.y, 0, pos.x, pos.y, r * 2); g.addColorStop(0, obj.color + '44'); g.addColorStop(1, 'transparent'); this.ctx.fillStyle = g; this.ctx.fillRect(pos.x - r * 2, pos.y - r * 2, r * 4, r * 4); } const g = this.ctx.createRadialGradient(pos.x - r * 0.3, pos.y - r * 0.3, 0, pos.x, pos.y, r); g.addColorStop(0, obj.color); g.addColorStop(1, obj.color + '88'); this.ctx.fillStyle = g; this.ctx.beginPath(); this.ctx.arc(pos.x, pos.y, r, 0, Math.PI * 2); this.ctx.fill(); if (obj.rings) { this.ctx.strokeStyle = obj.color + '66'; this.ctx.lineWidth = r * 0.4; this.ctx.beginPath(); this.ctx.ellipse(pos.x, pos.y, r * 2, r * 0.5, 0, 0, Math.PI * 2); this.ctx.stroke(); } if (isHovered) { this.ctx.fillStyle = '#fff'; this.ctx.font = '12px Orbitron'; this.ctx.textAlign = 'center'; this.ctx.fillText(obj.name, pos.x, pos.y - r - 10); } }); requestAnimationFrame(() => this.animate()); } };
      function openSpaceGallery() { showScreen('space'); setTimeout(() => SpaceGallery.init(), 100); }
      function closeSpaceGallery() { showScreen('lobby'); }
      function switchSpaceTab(tab) { SpaceGallery.loadTab(tab); }
      function resetSpaceView() { SpaceGallery.offset = { x: 0, y: 0 }; SpaceGallery.zoom = 1; SpaceGallery.rotation = 0; SpaceGallery.selectedObj = null; document.getElementById('zoom-slider').value = 1; document.getElementById('speed-slider').value = 1; document.getElementById('space-info').classList.remove('show'); document.querySelectorAll('.space-object-item').forEach(el => el.classList.remove('active')); }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // FIREWORKS ENGINE
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      const FW = (function () {
        const cv = document.getElementById('fw-canvas'), ctx = cv.getContext('2d');
        let particles = [], rockets = [], active = false, aid;
        function resize() { cv.width = innerWidth; cv.height = innerHeight; }
        addEventListener('resize', resize); resize();
        function explode(x, y, color, count = 85) {
          for (let i = 0; i < count; i++) { const a = (Math.PI * 2 / count) * i + Math.random() * 0.3, sp = 1.5 + Math.random() * 5.5; particles.push({ x, y, vx: Math.cos(a) * sp, vy: Math.sin(a) * sp - 1, life: 1, decay: 0.012 + Math.random() * 0.018, size: 1.5 + Math.random() * 3.5, color, trail: Math.random() < 0.2, pts: [], shape: Math.random() < 0.15 ? 'star' : 'circle' }); }
          // White sparkle ring
          for (let i = 0; i < 18; i++) { const a = (Math.PI * 2 / 18) * i; particles.push({ x, y, vx: Math.cos(a) * 0.6, vy: Math.sin(a) * 0.6, life: 1, decay: 0.04, size: 3.5, color: '#fff', trail: false, pts: [], shape: 'circle' }); }
        }
        function starPath(ctx, x, y, r) { const s = 4, ir = r * 0.4; ctx.beginPath(); for (let i = 0; i < s * 2; i++) { const a = (i / (s * 2)) * Math.PI * 2 - Math.PI / 2, rd = i % 2 === 0 ? r : ir; i === 0 ? ctx.moveTo(x + Math.cos(a) * rd, y + Math.sin(a) * rd) : ctx.lineTo(x + Math.cos(a) * rd, y + Math.sin(a) * rd); } ctx.closePath(); }
        function loop() {
          ctx.clearRect(0, 0, cv.width, cv.height);
          rockets.forEach((r, ri) => { r.progress = Math.min(1, r.progress + 0.04); r.y = cv.height + (r.ty - cv.height) * r.progress; const g = ctx.createRadialGradient(r.x, r.y, 0, r.x, r.y, 6); g.addColorStop(0, r.color); g.addColorStop(1, 'transparent'); ctx.beginPath(); ctx.arc(r.x, r.y, 3, 0, Math.PI * 2); ctx.fillStyle = g; ctx.fill(); if (r.progress >= 1) { explode(r.x, r.y, r.color); rockets.splice(ri, 1); } });
          particles = particles.filter(p => p.life > 0);
          particles.forEach(p => { p.vy += 0.06; if (p.trail) { p.pts.push({ x: p.x, y: p.y }); if (p.pts.length > 8) p.pts.shift(); } p.x += p.vx; p.y += p.vy; p.vx *= 0.96; p.vy *= 0.96; p.life -= p.decay; const al = Math.max(0, p.life); ctx.globalAlpha = al; ctx.fillStyle = p.color; ctx.shadowBlur = p.size * 3; ctx.shadowColor = p.color; if (p.trail && p.pts.length > 1) { ctx.beginPath(); ctx.moveTo(p.pts[0].x, p.pts[0].y); p.pts.forEach(pt => ctx.lineTo(pt.x, pt.y)); ctx.strokeStyle = p.color; ctx.lineWidth = p.size * 0.5; ctx.globalAlpha = al * 0.4; ctx.stroke(); ctx.globalAlpha = al; } if (p.shape === 'star') { starPath(ctx, p.x, p.y, p.size * 1.6); ctx.fill(); } else { ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); ctx.fill(); } });
          ctx.globalAlpha = 1; ctx.shadowBlur = 0; ctx.shadowColor = 'transparent';
          if (active || rockets.length || particles.length) aid = requestAnimationFrame(loop);
          else { ctx.clearRect(0, 0, cv.width, cv.height); aid = null; }
        }
        return {
          launch(c1, c2) {
            active = true;
            const cols = [c1, c2 || c1, '#fff', c1, c2 || c1, '#fffc', c1];
            [0.15, 0.3, 0.5, 0.7, 0.85, 0.25, 0.6, 0.42].forEach((xr, i) => {
              setTimeout(() => { rockets.push({ x: cv.width * xr, y: cv.height, ty: cv.height * (0.12 + Math.random() * 0.32), progress: 0, color: cols[i % cols.length] }); }, i * 210);
            });
            if (!aid) aid = requestAnimationFrame(loop);
            setTimeout(() => { active = false; }, 3200);
          },
          stop() { active = false; particles = []; rockets = []; ctx.clearRect(0, 0, cv.width, cv.height); }
        };
      })();

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // WIN LINE DRAW ‚Äî animated neon plasma strike
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      let winLineAnimId = null;
      function drawWinLine(lineIdx, color) {
        const wc = document.getElementById('win-canvas');
        const board = document.getElementById('board');
        const br = board.getBoundingClientRect();
        wc.width = br.width; wc.height = br.height;
        wc.style.width = br.width + 'px'; wc.style.height = br.height + 'px';
        const ctx = wc.getContext('2d');
        const cells = document.querySelectorAll('.cell');
        const f = cells[lineIdx[0]].getBoundingClientRect();
        const l = cells[lineIdx[2]].getBoundingClientRect();
        const x1 = f.left - br.left + f.width / 2, y1 = f.top - br.top + f.height / 2;
        const x2 = l.left - br.left + l.width / 2, y2 = l.top - br.top + l.height / 2;
        const dx = x2 - x1, dy = y2 - y1, len = Math.sqrt(dx * dx + dy * dy);
        const ux = dx / len, uy = dy / len, ext = 26;
        const sx = x1 - ux * ext, sy = y1 - uy * ext, ex = x2 + ux * ext, ey = y2 + uy * ext;
        let prog = 0;
        function drawFrame() {
          ctx.clearRect(0, 0, wc.width, wc.height);
          prog = Math.min(1, prog + 0.07);
          const cx2 = sx + (ex - sx) * prog, cy2 = sy + (ey - sy) * prog;
          ctx.lineCap = 'round';
          // Outer soft glow
          ctx.lineWidth = 28; ctx.strokeStyle = color + '18'; ctx.beginPath(); ctx.moveTo(sx, sy); ctx.lineTo(cx2, cy2); ctx.stroke();
          ctx.lineWidth = 16; ctx.strokeStyle = color + '30'; ctx.beginPath(); ctx.moveTo(sx, sy); ctx.lineTo(cx2, cy2); ctx.stroke();
          ctx.lineWidth = 8; ctx.strokeStyle = color + '66'; ctx.beginPath(); ctx.moveTo(sx, sy); ctx.lineTo(cx2, cy2); ctx.stroke();
          // Core
          ctx.lineWidth = 3.5; ctx.strokeStyle = color; ctx.shadowColor = color; ctx.shadowBlur = 20; ctx.beginPath(); ctx.moveTo(sx, sy); ctx.lineTo(cx2, cy2); ctx.stroke();
          // Bright center
          ctx.lineWidth = 1.5; ctx.strokeStyle = '#fff'; ctx.shadowBlur = 8; ctx.beginPath(); ctx.moveTo(sx, sy); ctx.lineTo(cx2, cy2); ctx.stroke();
          ctx.shadowBlur = 0;
          // Tip sparks while drawing
          if (prog < 1) { for (let i = 0; i < 4; i++) { const a = Math.random() * Math.PI * 2, r = Math.random() * 12; ctx.beginPath(); ctx.arc(cx2 + Math.cos(a) * r, cy2 + Math.sin(a) * r, 1 + Math.random() * 2, 0, Math.PI * 2); ctx.fillStyle = color; ctx.shadowColor = color; ctx.shadowBlur = 8; ctx.fill(); } }
          ctx.shadowBlur = 0;
          if (prog < 1) { winLineAnimId = requestAnimationFrame(drawFrame); }
          else {
            let pulse = 0;
            function pulseLine() {
              pulse += 0.055;
              ctx.clearRect(0, 0, wc.width, wc.height);
              const I = 0.55 + 0.45 * Math.sin(pulse);
              const a18 = Math.floor(I * 0x1e).toString(16).padStart(2, '0');
              const a55 = Math.floor(I * 0x60).toString(16).padStart(2, '0');
              ctx.lineCap = 'round';
              ctx.lineWidth = 28; ctx.strokeStyle = color + a18; ctx.beginPath(); ctx.moveTo(sx, sy); ctx.lineTo(ex, ey); ctx.stroke();
              ctx.lineWidth = 8; ctx.strokeStyle = color + a55; ctx.beginPath(); ctx.moveTo(sx, sy); ctx.lineTo(ex, ey); ctx.stroke();
              ctx.lineWidth = 3.5; ctx.strokeStyle = color; ctx.shadowColor = color; ctx.shadowBlur = I * 26; ctx.beginPath(); ctx.moveTo(sx, sy); ctx.lineTo(ex, ey); ctx.stroke();
              ctx.lineWidth = 1.5; ctx.strokeStyle = '#fff'; ctx.shadowBlur = 8; ctx.beginPath(); ctx.moveTo(sx, sy); ctx.lineTo(ex, ey); ctx.stroke();
              ctx.shadowBlur = 0;
              winLineAnimId = requestAnimationFrame(pulseLine);
            }
            pulseLine();
          }
        }
        requestAnimationFrame(drawFrame);
      }
      function clearWinLine() {
        if (winLineAnimId) { cancelAnimationFrame(winLineAnimId); winLineAnimId = null; }
        const c = document.getElementById('win-canvas');
        if (c) { const ctx = c.getContext('2d'); ctx.clearRect(0, 0, c.width, c.height); }
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // SCREEN FLASH
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      function screenFlash(color) {
        const el = document.getElementById('screen-flash');
        el.style.background = color; el.classList.add('flash');
        setTimeout(() => el.classList.remove('flash'), 80);
        setTimeout(() => { el.classList.add('flash'); setTimeout(() => el.classList.remove('flash'), 60); }, 200);
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // STATE
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      const S = { token: null, username: null, stats: { wins: 0, losses: 0, draws: 0 }, mode: null, roomCode: null, mySymbol: null, board: Array(9).fill(null), currentTurn: 'X', gameActive: false, players: [], scores: { X: 0, O: 0, D: 0 }, aiScores: { X: 0, O: 0, D: 0 }, ghostSym: 'X' };

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // SOCKET
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      const socket = io({ autoConnect: true, reconnectionAttempts: 5, withCredentials: true });
      socket.on('connect', () => { const t = S.token || localStorage.getItem('token'); if (t) socket.emit('auth', { token: t }); });
      socket.on('auth:ok', d => { S.username = d.username; S.stats = d.stats; updateLobbyUI(); showScreen('lobby'); });
      socket.on('auth:error', msg => { showToast(msg); doLogout(); });
      socket.on('room:created', ({ code, symbol }) => { S.roomCode = code; S.mySymbol = symbol; document.getElementById('waiting-code').textContent = code; showScreen('waiting'); });
      socket.on('room:error', msg => { document.getElementById('lobby-error').textContent = msg; setTimeout(() => document.getElementById('lobby-error').textContent = '', 3500); });
      socket.on('room:joined', ({ code, symbol }) => { S.roomCode = code; S.mySymbol = symbol; });
      socket.on('game:start', d => { S.board = d.board; S.currentTurn = d.currentTurn; S.players = d.players; S.scores = d.scores; S.gameActive = true; S.mode = 'online'; const me = d.players.find(p => p.name === S.username); if (me) S.mySymbol = me.symbol; initOnlineGame(); showScreen('game'); });
      socket.on('game:move', ({ index, symbol }) => { S.board[index] = symbol; renderCell(index, symbol); });
      socket.on('game:turn', ({ currentTurn }) => { S.currentTurn = currentTurn; updateGameStatus(); updatePanelHighlight(); S.ghostSym = currentTurn; updateGhosts(); });
      socket.on('game:over', ({ winner, line, draw, scores }) => {
        S.scores = scores; S.gameActive = false; updateScoreUI();
        if (line) { highlightWin(line, winner); drawWinLine(line, winner === 'X' ? '#ff4d6d' : '#4dffdb'); }
        if (winner) { const c = winner === 'X' ? '#ff4d6d' : '#4dffdb'; screenFlash(c + '44'); FW.launch(c, winner === 'X' ? '#ff7b93' : '#7bffec'); }
        setTimeout(() => showGameOver(winner, draw), 900);
      });
      socket.on('game:error', msg => showToast(msg));
      socket.on('game:opponent-left', () => { S.gameActive = false; showToast('Opponent disconnected!'); document.getElementById('ov-emoji').textContent = 'üëã'; document.getElementById('ov-result').textContent = 'Opponent Left'; document.getElementById('ov-result').className = 'overlay-result draw'; document.getElementById('ov-sub').textContent = 'ABANDONED'; document.getElementById('ov-score').textContent = ''; document.getElementById('ov-rematch').textContent = ''; document.getElementById('ov-actions').innerHTML = '<button class="btn btn-primary" onclick="leaveGame()">Back to Lobby</button>'; triggerRings('d'); document.getElementById('overlay').classList.add('show'); });
      socket.on('game:rematch-request', ({ from }) => { document.getElementById('ov-rematch').textContent = `${from} wants a rematch!`; });
      socket.on('chat:msg', ({ from, text }) => addChat(from, text, from === S.username ? 'me' : 'them'));
      socket.on('disconnect', () => showToast('Connection lost. Reconnecting‚Ä¶'));

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // AUTH
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      function getCookie(name) { const v = `; ${document.cookie}`; const p = v.split(`; ${name}=`); if (p.length === 2) return p.pop().split(';').shift(); }
      function switchTab(t) { document.getElementById('form-login').style.display = t === 'login' ? 'flex' : 'none'; document.getElementById('form-register').style.display = t === 'register' ? 'flex' : 'none'; document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', (i === 0 && t === 'login') || (i === 1 && t === 'register'))); }
      async function doLogin(btn) { const u = document.getElementById('login-user').value.trim(), p = document.getElementById('login-pass').value, e = document.getElementById('login-error'); e.textContent = ''; if (!u || !p) { e.textContent = 'Please fill in all fields.'; e.classList.remove('shake'); void e.offsetWidth; e.classList.add('shake'); return; } btn.disabled = true; btn.textContent = 'Signing in‚Ä¶'; const r = await fetchJSON('/api/login', { username: u, password: p }); btn.disabled = false; btn.textContent = 'Sign In ‚Üí'; if (!r.ok) { e.textContent = r.error; e.classList.remove('shake'); void e.offsetWidth; e.classList.add('shake'); return; } storeSession(r); }
      async function doRegister(btn) { const u = document.getElementById('reg-user').value.trim(), p = document.getElementById('reg-pass').value, e = document.getElementById('reg-error'); e.textContent = ''; if (!u || !p) { e.textContent = 'Please fill in all fields.'; e.classList.remove('shake'); void e.offsetWidth; e.classList.add('shake'); return; } btn.disabled = true; btn.textContent = 'Creating‚Ä¶'; const r = await fetchJSON('/api/register', { username: u, password: p }); btn.disabled = false; btn.textContent = 'Create Account ‚Üí'; if (!r.ok) { e.textContent = r.error; e.classList.remove('shake'); void e.offsetWidth; e.classList.add('shake'); return; } storeSession(r); }
      function storeSession({ token, username, stats }) { S.token = token; S.username = username; S.stats = stats; localStorage.setItem('token', token); socket.emit('auth', { token }); }
      async function doLogout() { await fetch('/api/logout', { method: 'POST', credentials: 'include' }); S.token = S.username = null; localStorage.removeItem('token'); showScreen('auth'); }
      function updateLobbyUI() { document.getElementById('lobby-username').textContent = S.username; document.getElementById('lobby-avatar').textContent = S.username?.[0]?.toUpperCase() || '?'; document.getElementById('stat-w').textContent = S.stats?.wins || 0; document.getElementById('stat-d').textContent = S.stats?.draws || 0; document.getElementById('stat-l').textContent = S.stats?.losses || 0; }
      async function fetchJSON(url, body) { const r = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify(body) }); return r.json(); }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // LOBBY
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      function createRoom() { document.getElementById('lobby-error').textContent = ''; socket.emit('room:create'); }
      function joinRoom() { const c = document.getElementById('join-code').value.trim().toUpperCase(); if (c.length !== 4) { document.getElementById('lobby-error').textContent = 'Code must be 4 characters'; return; } document.getElementById('lobby-error').textContent = ''; socket.emit('room:join', { code: c }); }
      function cancelWaiting() { if (S.roomCode) socket.emit('room:leave', { code: S.roomCode }); S.roomCode = null; showScreen('lobby'); }
      function copyCode() { navigator.clipboard?.writeText(S.roomCode).catch(() => { }); const b = document.getElementById('copy-btn'); b.textContent = '‚úì Copied!'; b.classList.add('copied'); setTimeout(() => { b.textContent = 'üìã Copy Code'; b.classList.remove('copied'); }, 2000); }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // AI
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      const WINS = [[0, 1, 2], [3, 4, 5], [6, 7, 8], [0, 3, 6], [1, 4, 7], [2, 5, 8], [0, 4, 8], [2, 4, 6]];
      function startAI() { S.mode = 'ai'; S.mySymbol = 'X'; S.players = [{ name: S.username || 'You', symbol: 'X' }, { name: 'AI', symbol: 'O' }]; S.board = Array(9).fill(null); S.currentTurn = 'X'; S.gameActive = true; S.aiScores = { X: 0, O: 0, D: 0 }; S.ghostSym = 'X'; buildBoard(); updateNameBanners(); updatePanelHighlight(); updateGameStatus(); updateScoreUI(); document.getElementById('btn-new-ai').style.display = 'inline-block'; document.getElementById('chat-col').style.display = 'none'; showScreen('game'); }
      function newAIGame() { S.board = Array(9).fill(null); S.currentTurn = 'X'; S.gameActive = true; S.ghostSym = 'X'; S.scores = { ...S.aiScores }; clearWinLine(); FW.stop(); buildBoard(); updateGameStatus(); updatePanelHighlight(); updateScoreUI(); document.getElementById('overlay').classList.remove('show'); }
      function winLocal(b, pl) { for (const l of WINS) if (l.every(i => b[i] === pl)) return l; return null; }
      function minimax(b, d, mx) { if (winLocal(b, 'O')) return 10 - d; if (winLocal(b, 'X')) return d - 10; if (b.every(Boolean)) return 0; if (mx) { let bv = -Infinity; for (let i = 0; i < 9; i++)if (!b[i]) { b[i] = 'O'; bv = Math.max(bv, minimax(b, d + 1, false)); b[i] = null; } return bv; } else { let bv = Infinity; for (let i = 0; i < 9; i++)if (!b[i]) { b[i] = 'X'; bv = Math.min(bv, minimax(b, d + 1, true)); b[i] = null; } return bv; } }
      function getBest() { let bv = -Infinity, mv = -1; for (let i = 0; i < 9; i++)if (!S.board[i]) { S.board[i] = 'O'; const sc = minimax(S.board, 0, false); S.board[i] = null; if (sc > bv) { bv = sc; mv = i; } } return mv; }
      function aiMove() { if (!S.gameActive || S.mode !== 'ai' || S.currentTurn !== 'O') return; const idx = getBest(); if (idx === -1) return; S.board[idx] = 'O'; renderCell(idx, 'O'); const wl = winLocal(S.board, 'O'); if (wl) { S.gameActive = false; highlightWin(wl, 'O'); drawWinLine(wl, '#4dffdb'); S.aiScores.O++; S.scores = { ...S.aiScores }; updateScoreUI(); screenFlash('#4dffdb44'); FW.launch('#4dffdb', '#7bffec'); setTimeout(() => showGameOver('O', false), 900); return; } if (S.board.every(Boolean)) { S.gameActive = false; S.aiScores.D++; S.scores = { ...S.aiScores }; updateScoreUI(); setTimeout(() => showGameOver(null, true), 500); return; } S.currentTurn = 'X'; S.ghostSym = 'X'; updateGameStatus(); updatePanelHighlight(); updateGhosts(); }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // GAME INIT
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      function initOnlineGame() { document.getElementById('overlay').classList.remove('show'); clearWinLine(); FW.stop(); buildBoard(); updateNameBanners(); updatePanelHighlight(); updateGameStatus(); updateScoreUI(); document.getElementById('btn-new-ai').style.display = 'none'; document.getElementById('chat-col').style.display = 'flex'; S.ghostSym = S.mySymbol; addChat('System', 'Game started! Good luck.', 'sys'); }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // BOARD + CELLS
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      function buildBoard() {
        const b = document.getElementById('board'); b.innerHTML = '';
        for (let i = 0; i < 9; i++) {
          const cell = document.createElement('div'); cell.className = 'cell'; cell.dataset.i = i;
          // Ghost preview SVGs
          cell.innerHTML = `<svg class="ghost-preview ghost-x" viewBox="0 0 50 50"><line x1="12" y1="12" x2="38" y2="38" stroke="#fff" stroke-width="5.5" stroke-linecap="round"/><line x1="38" y1="12" x2="12" y2="38" stroke="#fff" stroke-width="5.5" stroke-linecap="round"/></svg><svg class="ghost-preview ghost-o" viewBox="0 0 50 50" style="display:none"><circle cx="25" cy="25" r="15" stroke="#fff" stroke-width="5.5" fill="none"/></svg>`;
          cell.addEventListener('click', onCellClick); b.appendChild(cell);
        }
        updateGhosts();
      }
      function updateGhosts() {
        document.querySelectorAll('.cell:not(.taken)').forEach(c => {
          const gx = c.querySelector('.ghost-x'), go = c.querySelector('.ghost-o');
          if (gx) gx.style.display = S.ghostSym === 'X' ? 'block' : 'none';
          if (go) go.style.display = S.ghostSym === 'O' ? 'block' : 'none';
        });
      }
      function onCellClick(e) {
        const i = +e.currentTarget.dataset.i; if (!S.gameActive || S.board[i]) return;
        if (S.mode === 'ai') {
          if (S.currentTurn !== 'X') return;
          S.board[i] = 'X'; renderCell(i, 'X');
          const wl = winLocal(S.board, 'X'); if (wl) { S.gameActive = false; highlightWin(wl, 'X'); drawWinLine(wl, '#ff4d6d'); S.aiScores.X++; S.scores = { ...S.aiScores }; updateScoreUI(); screenFlash('#ff4d6d44'); FW.launch('#ff4d6d', '#ff7b93'); setTimeout(() => showGameOver('X', false), 900); return; }
          if (S.board.every(Boolean)) { S.gameActive = false; S.aiScores.D++; S.scores = { ...S.aiScores }; updateScoreUI(); setTimeout(() => showGameOver(null, true), 500); return; }
          S.currentTurn = 'O'; S.ghostSym = 'O'; updateGameStatus(); updatePanelHighlight(); updateGhosts(); setTimeout(aiMove, 440);
        } else if (S.mode === 'online') {
          if (S.currentTurn !== S.mySymbol) return;
          socket.emit('game:move', { code: S.roomCode, index: i });
        }
      }
      function renderCell(i, player) {
        const cell = document.querySelector(`.cell[data-i="${i}"]`); if (!cell) return;
        cell.classList.add('taken', player === 'X' ? 'x-cell' : 'o-cell', 'just-placed');
        cell.innerHTML = player === 'X' ? `<svg class="symbol x-sym" viewBox="0 0 50 50"><line x1="11" y1="11" x2="39" y2="39"/><line x1="39" y1="11" x2="11" y2="39"/></svg>` : `<svg class="symbol o-sym" viewBox="0 0 50 50"><circle cx="25" cy="25" r="16"/></svg>`;
        const r = document.createElement('div'); r.className = 'ripple'; r.style.background = player === 'X' ? '#ff4d6d' : '#4dffdb'; cell.appendChild(r);
        r.addEventListener('animationend', () => r.remove());
        cell.addEventListener('animationend', () => cell.classList.remove('just-placed'), { once: true });
        if (S.mode === 'online') { S.ghostSym = player === 'X' ? 'O' : 'X'; updateGhosts(); }
      }
      function highlightWin(line, player) {
        document.getElementById('board').classList.add('shake');
        setTimeout(() => document.getElementById('board').classList.remove('shake'), 600);
        line.forEach(i => { const c = document.querySelector(`.cell[data-i="${i}"]`); if (c) c.classList.add('win-cell'); });
      }
      function updateGameStatus() {
        const dot = document.getElementById('status-dot'), txt = document.getElementById('status-text');
        const isX = S.currentTurn === 'X', color = isX ? '#ff4d6d' : '#4dffdb';
        dot.style.background = color; dot.style.boxShadow = `0 0 8px ${color}`;
        txt.textContent = S.mode === 'online' ? (S.currentTurn === S.mySymbol ? 'Your turn' : "Opponent's turn") : (isX ? 'Your turn' : 'AI thinking‚Ä¶');
        document.getElementById('game-status').style.color = color;
      }
      function updatePanelHighlight() { document.getElementById('panel-x').classList.toggle('active-x', S.currentTurn === 'X' && S.gameActive); document.getElementById('panel-o').classList.toggle('active-o', S.currentTurn === 'O' && S.gameActive); }
      function updateNameBanners() { if (!S.players.length) return; const px = S.players.find(p => p.symbol === 'X'), po = S.players.find(p => p.symbol === 'O'); if (px) { document.getElementById('name-x').textContent = px.name; document.getElementById('role-x').textContent = (S.mode === 'online' && px.name === S.username) ? 'You (X)' : (S.mode === 'ai') ? 'You' : 'Player X'; } if (po) { document.getElementById('name-o').textContent = po.name; document.getElementById('role-o').textContent = (S.mode === 'online' && po.name === S.username) ? 'You (O)' : (S.mode === 'ai') ? 'AI' : 'Player O'; } }
      function updateScoreUI() { const sc = S.mode === 'ai' ? S.aiScores : S.scores; document.getElementById('gs-x').textContent = sc.X || 0; document.getElementById('gs-o').textContent = sc.O || 0; document.getElementById('gs-d').textContent = sc.D || 0; document.getElementById('score-x').textContent = sc.X || 0; document.getElementById('score-o').textContent = sc.O || 0; document.getElementById('score-x').className = 'pp-score' + (sc.X > 0 ? ' hx' : ''); document.getElementById('score-o').className = 'pp-score' + (sc.O > 0 ? ' ho' : ''); }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // OVERLAY
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      function triggerRings(t) { ['ov-r1', 'ov-r2', 'ov-r3'].forEach(id => { const el = document.getElementById(id); el.className = `ov-ring ${t === 'x' ? 'x-ring' : t === 'o' ? 'o-ring' : 'd-ring'}`; void el.offsetWidth; el.classList.add('go'); }); }
      function showGameOver(winner, isDraw) {
        const ov = document.getElementById('overlay'), res = document.getElementById('ov-result'), sub = document.getElementById('ov-sub'), sc = document.getElementById('ov-score'), rm = document.getElementById('ov-rematch'), acts = document.getElementById('ov-actions'), glow = document.getElementById('ov-glow'), em = document.getElementById('ov-emoji');
        rm.textContent = ''; res.className = 'overlay-result';
        const scores = S.mode === 'ai' ? S.aiScores : S.scores; sc.textContent = `X ${scores.X}  ‚Äî  D ${scores.D}  ‚Äî  O ${scores.O}`;
        if (isDraw || !winner) { em.textContent = 'ü§ù'; res.textContent = "It's a Draw!"; res.classList.add('draw'); sub.textContent = 'STALEMATE'; glow.style.background = '#888'; triggerRings('d'); }
        else if (winner === 'X') { const w = S.mode === 'ai' || S.mySymbol === 'X'; em.textContent = w ? 'üèÜ' : '‚ùå'; res.textContent = w ? 'You Win!' : 'X Wins!'; res.classList.add('x-win'); sub.textContent = w ? 'VICTORY' : 'X WINS'; glow.style.background = '#ff4d6d'; triggerRings('x'); }
        else { const w = S.mode !== 'ai' && S.mySymbol === 'O'; em.textContent = S.mode === 'ai' ? 'ü§ñ' : (w ? 'üèÜ' : '‚≠ï'); res.textContent = S.mode === 'ai' ? 'AI Wins!' : (w ? 'You Win!' : 'O Wins!'); res.classList.add('o-win'); sub.textContent = S.mode === 'ai' ? 'DEFEATED' : (w ? 'VICTORY' : 'O WINS'); glow.style.background = '#4dffdb'; triggerRings('o'); }
        acts.innerHTML = S.mode === 'ai' ? `<button class="btn btn-primary" onclick="newAIGame()">Play Again</button><button class="btn" onclick="leaveGame()">Lobby</button>` : `<button class="btn btn-primary" id="btn-rematch" onclick="requestRematch()">Rematch</button><button class="btn" onclick="leaveGame()">Leave</button>`;
        ov.classList.add('show');
      }
      function requestRematch() { socket.emit('game:rematch', { code: S.roomCode }); document.getElementById('btn-rematch').textContent = 'Waiting‚Ä¶'; document.getElementById('btn-rematch').disabled = true; document.getElementById('ov-rematch').textContent = 'Waiting for opponent‚Ä¶'; }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // LEAVE
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      function leaveGame() { document.getElementById('overlay').classList.remove('show'); if (S.mode === 'online' && S.roomCode) socket.emit('room:leave', { code: S.roomCode }); S.roomCode = null; S.mode = null; S.gameActive = false; S.scores = { X: 0, O: 0, D: 0 }; clearWinLine(); FW.stop(); document.getElementById('join-code').value = ''; showScreen('lobby'); }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // CHAT
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      function sendChat() { const inp = document.getElementById('chat-input'), txt = inp.value.trim(); if (!txt || !S.roomCode) return; socket.emit('chat:msg', { code: S.roomCode, text: txt }); inp.value = ''; }
      document.getElementById('chat-input').addEventListener('keydown', e => { if (e.key === 'Enter') sendChat(); });
      function addChat(from, text, type) { const box = document.getElementById('chat-messages'), msg = document.createElement('div'); msg.className = 'chat-msg'; msg.innerHTML = `<div class="chat-msg-from ${type}">${type === 'sys' ? '‚ö° System' : esc(from)}</div><div class="chat-msg-text ${type === 'sys' ? 'sys' : ''}">${esc(text)}</div>`; box.appendChild(msg); box.scrollTop = box.scrollHeight; }
      function esc(s) { return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // UTIL
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      function showScreen(n) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); const t = document.getElementById(`screen-${n}`); if (t) t.classList.add('active'); }
      let toastTimer;
      function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); clearTimeout(toastTimer); toastTimer = setTimeout(() => t.classList.remove('show'), 3000); }
      document.addEventListener('keydown', e => { if (e.key === 'Enter') { const a = document.querySelector('.screen.active')?.id; if (a === 'screen-auth') (document.querySelector('.tab-btn.active')?.textContent === 'Sign In' ? doLogin : doRegister)(); } });
      (function init() { const s = localStorage.getItem('token'); if (s) { S.token = s; socket.emit('auth', { token: s }); } })();
  </script>
</body>

</html>